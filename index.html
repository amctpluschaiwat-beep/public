<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMS Pro - Apple Workstation</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <style>
        /* --- GOOGLE AI STUDIO DARK THEME --- */
        :root {
            --bg-primary: #1a1a1a; /* Dark background */
            --bg-secondary: #2a2a2a; /* Secondary dark */
            --bg-card: #2d2d2d; /* Card background */
            --sidebar-bg: #1f1f1f; /* Sidebar dark */
            --glass-bg: rgba(45, 45, 45, 0.95); /* Dark glass surface */
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
            --accent: #8ab4f8; /* Google blue accent */
            --accent-hover: #aac7fa;
            --text-primary: #e8eaed; /* Light text */
            --text-secondary: #9aa0a6; /* Gray text */
            --border-color: rgba(255, 255, 255, 0.12);
        }

        body {
            font-family: 'Kanit', sans-serif;
            background-color: var(--bg-primary);
            background-image: 
                radial-gradient(at 40% 20%, hsla(228,70%,50%,0.08) 0px, transparent 50%),
                radial-gradient(at 80% 0%, hsla(189,70%,50%,0.08) 0px, transparent 50%),
                radial-gradient(at 0% 50%, hsla(340,70%,50%,0.06) 0px, transparent 50%);
            height: 100vh;
            overflow: hidden;
            color: var(--text-primary);
        }

        /* Glass Components */
        .glass-panel {
            background: var(--glass-bg);
            -webkit-backdrop-filter: blur(10px) saturate(120%);
            backdrop-filter: blur(10px) saturate(120%);
            border: 1px solid var(--border-color);
            box-shadow: var(--glass-shadow);
            border-radius: 16px;
            color: var(--text-primary);
        }

        .glass-sidebar {
            background: var(--sidebar-bg);
            -webkit-backdrop-filter: blur(40px);
            backdrop-filter: blur(40px);
            color: var(--text-primary);
            border-right: 1px solid var(--border-color);
        }

        /* list item highlight for selected / focused rows */
        .list-highlight { background: rgba(138, 180, 248, 0.15); }

        /* Interactive Elements */
        .menu-item {
            border-radius: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
            opacity: 0.7;
            color: var(--text-secondary);
        }
        .menu-item:hover { 
            background: rgba(138, 180, 248, 0.1); 
            opacity: 1;
            color: var(--text-primary);
        }
        .menu-item.active {
            background: rgba(138, 180, 248, 0.2);
            color: var(--accent);
            border-left: 3px solid var(--accent);
            opacity: 1;
            font-weight: 600;
        }

        .btn-apple {
            border-radius: 99px;
            transition: all 0.2s;
            font-weight: 500;
        }
        .btn-primary {
            background: var(--accent);
            color: #1a1a1a;
            box-shadow: 0 4px 10px rgba(138, 180, 248, 0.3);
        }
        .btn-primary:hover { 
            background: var(--accent-hover);
            transform: translateY(-1px); 
            box-shadow: 0 6px 15px rgba(138, 180, 248, 0.4); 
        }

        /* Inputs */
        .apple-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 10px 16px;
            transition: 0.2s;
            outline: none;
            color: var(--text-primary);
        }
        .apple-input:focus { 
            background: var(--bg-card); 
            box-shadow: 0 0 0 3px rgba(138, 180, 248, 0.3);
            border-color: var(--accent);
        }

        /* Utility */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }

        /* Progress Bar Widths */
        .w-0 { width: 0%; }
        .w-10 { width: 10%; }
        .w-20 { width: 20%; }
        .w-30 { width: 30%; }
        .w-40 { width: 40%; }
        .w-50 { width: 50%; }
        .w-60 { width: 60%; }
        .w-70 { width: 70%; }
        .w-80 { width: 80%; }
        .w-90 { width: 90%; }
        .w-100 { width: 100%; }
        
        /* Payment Option */
        .pay-option { 
            cursor: pointer; 
            transition: all 0.2s; 
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .pay-option.selected { 
            background: rgba(138, 180, 248, 0.15); 
            border-color: var(--accent); 
            color: var(--accent); 
        }

        /* Utilities & components */
        .btn-secondary { 
            background: transparent; 
            border: 1px solid var(--border-color); 
            color: var(--text-primary); 
            border-radius: 12px; 
            padding: 0.5rem 1rem; 
        }
        .btn-secondary:hover {
            background: var(--bg-secondary);
            border-color: var(--accent);
        }
        .badge { 
            display: inline-block; 
            padding: 0.15rem 0.5rem; 
            border-radius: 999px; 
            font-size: 0.65rem; 
        }

        /* Customer card improvements to avoid overlap */
        .customer-card { 
            background: var(--bg-card); 
            border-radius: 12px; 
            padding: 1rem; 
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--border-color);
        }
        .customer-card .meta { 
            font-size: 0.78rem; 
            color: var(--text-secondary); 
        }

        /* Timeline */
        .timeline-line { position: relative; padding-left: 1.25rem; }
        .timeline-dot { 
            width: 10px; 
            height: 10px; 
            border-radius: 50%; 
            background: var(--accent); 
            position: absolute; 
            left: 0; 
            top: 6px; 
            border: 2px solid var(--bg-card); 
        }

        /* Small responsive fixes */
        @media (max-width: 768px) {
            aside.w-72 { width: 56px; }
            .menu-item span { display: none; }
        }

        /* Login Screen Animations */
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.5s ease-out;
        }

        /* Hide main app when not logged in */
        body.logged-out #app-container {
            display: none !important;
        }
        body.logged-in #login-screen {
            display: none !important;
        }
    </style>
</head>
<body class="flex text-sm logged-out">

    <!-- Login Screen (shown before authentication) -->
    <div id="login-screen" class="fixed inset-0 z-[100] flex items-center justify-center" style="background: var(--bg-primary);">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcz48cGF0dGVybiBpZD0iZ3JpZCIgd2lkdGg9IjQwIiBoZWlnaHQ9IjQwIiBwYXR0ZXJuVW5pdHM9InVzZXJTcGFjZU9uVXNlIj48cGF0aCBkPSJNIDQwIDAgTCAwIDAgMCA0MCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLW9wYWNpdHk9IjAuMDUiIHN0cm9rZS13aWR0aD0iMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNncmlkKSIvPjwvc3ZnPg==')] opacity-20"></div>
        
        <div class="relative glass-panel p-10 w-full max-w-md shadow-2xl animate-fade-in">
            <div class="text-center mb-8">
                <div class="inline-block p-4 rounded-2xl shadow-lg mb-4" style="background: var(--accent);">
                    <i class="fas fa-shield-halved text-5xl" style="color: var(--bg-primary);"></i>
                </div>
                <h1 class="text-3xl font-bold mb-2" style="color: var(--text-primary);">TMS <span class="font-light">Pro</span></h1>
                <p class="text-sm" style="color: var(--text-secondary);">Asset Management System</p>
            </div>

            <form id="login-form" class="space-y-4" onsubmit="return app.handleLogin(event)">
                <div>
                    <label class="block text-xs font-semibold mb-2" style="color: var(--text-primary);">Username</label>
                    <div class="relative">
                        <i class="fas fa-user absolute left-4 top-1/2 transform -translate-y-1/2" style="color: var(--text-secondary);"></i>
                        <input 
                            type="text" 
                            id="login-username" 
                            class="apple-input w-full pl-12 pr-4 py-3" 
                            placeholder="Enter username"
                            required
                            autocomplete="username"
                        />
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold mb-2" style="color: var(--text-primary);">Password</label>
                    <div class="relative">
                        <i class="fas fa-lock absolute left-4 top-1/2 transform -translate-y-1/2" style="color: var(--text-secondary);"></i>
                        <input 
                            type="password" 
                            id="login-password" 
                            class="apple-input w-full pl-12 pr-4 py-3" 
                            placeholder="Enter password"
                            required
                            autocomplete="current-password"
                        />
                    </div>
                </div>

                <div class="flex items-center justify-between text-xs">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="remember-me" class="rounded">
                        <span style="color: var(--text-secondary);">Remember me</span>
                    </label>
                </div>

                <button type="submit" class="btn-apple btn-primary w-full py-3 text-base font-semibold shadow-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                </button>

                <div id="login-error" class="hidden text-xs text-red-600 bg-red-50 border border-red-200 rounded-lg p-3 text-center">
                    <i class="fas fa-exclamation-circle mr-1"></i>
                    <span id="login-error-msg">Invalid credentials</span>
                </div>
            </form>

            <div class="mt-6 pt-6 border-t border-gray-200 text-center">
                <p class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    Default: admin / admin1234
                </p>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden until logged in) -->
    <div id="app-container" class="flex w-full h-full">
    <aside class="w-72 glass-sidebar h-full flex flex-col z-50 shadow-2xl">
        <div class="p-8 text-center border-b border-white/10">
            <h1 class="text-3xl font-bold tracking-tight text-white">TMS <span class="font-light">Pro</span></h1>
            <p class="text-[10px] text-blue-200 uppercase tracking-widest mt-1">Asset Management</p>
        </div>

        <nav class="flex-1 overflow-y-auto py-6 px-4 space-y-2">
            <div onclick="app.navTo('dashboard', this)" class="menu-item active p-3 flex items-center gap-3">
                <i class="fas fa-chart-pie w-5 text-center"></i> Dashboard
            </div>

            <div class="pt-6 pb-2 px-3 text-[10px] font-bold text-gray-400 uppercase">Workstation</div>

            <div onclick="app.toggleSub('sub-con')" class="menu-item p-3 flex items-center justify-between group">
                <div class="flex items-center gap-3"><i class="fas fa-file-contract w-5 text-center"></i> สัญญา</div>
                <i class="fas fa-chevron-down text-xs opacity-50"></i>
            </div>
            <div id="sub-con" class="hidden pl-4 space-y-1">
                <div onclick="app.navTo('list', this, '')" class="menu-item p-2 text-xs pl-9">รายการทั้งหมด</div>
                <div onclick="app.navTo('list', this, 'Approved')" class="menu-item p-2 text-xs pl-9">สัญญาอนุมัติ</div>
                <div onclick="app.navTo('list', this, 'Closed')" class="menu-item p-2 text-xs pl-9">สัญญาสิ้นสุด</div>
                <div onclick="app.navTo('list', this, 'Active')" class="menu-item p-2 text-xs pl-9">สัญญาอยู่ในระบบ</div>
            </div>

            <div onclick="app.navTo('customers', this)" class="menu-item p-3 flex items-center gap-3">
                <i class="fas fa-users w-5 text-center"></i> ลูกค้า & Call Logs
            </div>
            
            <div onclick="app.toggleSub('sub-ass')" class="menu-item p-3 flex items-center justify-between group">
                <div class="flex items-center gap-3"><i class="fas fa-box w-5 text-center"></i> สินทรัพย์</div>
                <i class="fas fa-chevron-down text-xs opacity-50"></i>
            </div>
            <div id="sub-ass" class="hidden pl-4 space-y-1">
                <div onclick="app.navTo('assets-leased', this)" class="menu-item p-2 text-xs pl-9">ในระบบผ่อน</div>
                <div onclick="app.navTo('assets-stock', this)" class="menu-item p-2 text-xs pl-9">สต็อกสินค้า (QC)</div>
            </div>

            <div class="pt-6 pb-2 px-3 text-[10px] font-bold text-gray-400 uppercase">System</div>
            
            <div onclick="app.navTo('reports', this)" class="menu-item p-3 flex items-center gap-3">
                <i class="fas fa-chart-line w-5 text-center"></i> รายงานการเงิน
            </div>
            
            <div onclick="app.toggleSub('sub-settings')" class="menu-item p-3 flex items-center justify-between group">
                <div class="flex items-center gap-3"><i class="fas fa-cog w-5 text-center"></i> ตั้งค่า</div>
                <i class="fas fa-chevron-down text-xs opacity-50"></i>
            </div>
            <div id="sub-settings" class="hidden pl-4 space-y-1">
                <div onclick="app.navTo('users', this)" class="menu-item p-2 text-xs pl-9">จัดการผู้ใช้งาน</div>
                <div onclick="app.navTo('receipts', this)" class="menu-item p-2 text-xs pl-9">ตั้งค่าใบเสร็จ</div>
                <div onclick="app.showCallLogs()" class="menu-item p-2 text-xs pl-9">จัดการการโทร</div>
                <div onclick="app.showStatusLogs()" class="menu-item p-2 text-xs pl-9">ดูประวัติการเปลี่ยนสถานะ</div>
                <div onclick="app.openUploadSettings()" class="menu-item p-2 text-xs pl-9">ตั้งค่า API/Application</div>
            </div>
        </nav>

        <div class="p-4 bg-black/20 backdrop-blur-md">
            <div class="flex items-center gap-3 mb-3">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold text-lg">A</div>
                <div class="flex-1">
                    <p id="user-display-name" class="text-xs font-bold text-white">Admin User</p>
                    <p class="text-[10px] text-green-400"><i class="fas fa-circle text-[6px] mr-1"></i>Online</p>
                </div>
            </div>
            <button onclick="app.logout()" class="w-full btn-secondary py-2 text-xs flex items-center justify-center gap-2 hover:bg-red-500 hover:text-white transition">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative z-10">
        <header class="h-20 px-8 flex items-center justify-between z-40 glass-header sticky top-0 bg-white/50 backdrop-blur-md">
            <h2 class="text-2xl font-bold text-gray-800" id="page-title">Overview</h2>
            <div class="flex items-center gap-3" id="header-user-area">
                <div id="user-badge" class="flex items-center gap-3">
                    <div id="user-avatar" class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center text-white font-bold">A</div>
                    <div class="text-right leading-none">
                        <div id="user-name" class="text-xs font-bold text-gray-800">Guest</div>
                        <div id="user-role" class="text-[10px] text-gray-500">Not signed in</div>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 pb-20" id="main-scroll">
            
            <div id="view-dashboard" class="page-view fade-in max-w-7xl mx-auto">
                <div class="mb-6 flex gap-4 items-center justify-between">
                    <div class="flex items-center gap-3">
                        <label class="text-xs text-gray-500">จาก</label>
                        <input type="date" id="dash-start" class="apple-input text-xs" placeholder="เลือกวันที่เริ่มต้น" title="เลือกวันที่เริ่มต้น">
                        <label class="text-xs text-gray-500">ถึง</label>
                        <input type="date" id="dash-end" class="apple-input text-xs" title="เลือกวันที่สิ้นสุด" placeholder="เลือกวันที่สิ้นสุด">
                        <button onclick="app.renderDashboard()" class="btn-secondary ml-2">แสดง</button>
                    </div>
                    <div class="text-xs text-gray-500">ช่วงเวลาสำหรับ Dashboard</div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="glass-panel p-6">
                        <p class="text-xs text-gray-500 uppercase font-bold">ยอดเก็บได้จริง</p>
                        <h3 class="text-3xl font-bold text-gray-900 mt-2" id="d-collected">0 ฿</h3>
                    </div>
                    <div class="glass-panel p-6">
                        <p class="text-xs text-gray-500 uppercase font-bold">สัญญาในระบบ</p>
                        <h3 class="text-3xl font-bold text-green-600 mt-2" id="d-active">0</h3>
                    </div>
                    <div class="glass-panel p-6">
                        <p class="text-xs text-gray-500 uppercase font-bold">รออนุมัติ</p>
                        <h3 class="text-3xl font-bold text-orange-500 mt-2" id="d-pending">0</h3>
                    </div>
                    <div class="glass-panel p-6">
                        <p class="text-xs text-gray-500 uppercase font-bold">ค้างชำระ</p>
                        <h3 class="text-3xl font-bold text-red-500 mt-2" id="d-overdue">0</h3>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="glass-panel p-6 md:col-span-2">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold">Analytics</h4>
                            <div class="text-xs text-gray-500">อัปเดตตามช่วงวันที่</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="p-4 bg-white/50 rounded-xl">
                                <canvas id="chart-status" height="180"></canvas>
                            </div>
                            <div class="p-4 bg-white/50 rounded-xl">
                                <canvas id="chart-revenue" height="180"></canvas>
                            </div>
                        </div>
                    </div>

                        <!-- Authentication Modals -->
                        <div id="modal-login" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold">Sign In</h4>
                                    <button onclick="app.closeModal('modal-login')" class="text-gray-500"><i class="fas fa-times"></i></button>
                                </div>
                                <div class="space-y-3">
                                    <input id="login-username" class="apple-input w-full" placeholder="Username or email">
                                    <input id="login-password" type="password" class="apple-input w-full" placeholder="Password">
                                    <div class="flex items-center justify-between">
                                        <button onclick="app.login()" class="btn-apple btn-primary px-4 py-2">Sign in</button>
                                        <button onclick="app.showRegister()" class="btn-secondary px-3 py-2">Register</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="modal-register" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold">Register (request approval)</h4>
                                    <button onclick="app.closeModal('modal-register')" class="text-gray-500"><i class="fas fa-times"></i></button>
                                </div>
                                <div class="space-y-3">
                                    <input id="reg-username" class="apple-input w-full" placeholder="Username">
                                    <input id="reg-display" class="apple-input w-full" placeholder="Display name">
                                    <input id="reg-password" type="password" class="apple-input w-full" placeholder="Password">
                                    <div class="text-xs text-gray-500">New registrations require admin approval before they can act in the system.</div>
                                    <div class="mt-3 text-right">
                                        <button onclick="app.register()" class="btn-apple btn-primary px-4 py-2">Request Access</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="modal-admin-users" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
                            <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl p-6">
                                <div class="flex justify-between items-center mb-4">
                                    <h4 class="font-bold">Admin: User Management</h4>
                                    <button onclick="app.closeModal('modal-admin-users')" class="text-gray-500"><i class="fas fa-times"></i></button>
                                </div>
                                <div class="mb-4">
                                    <div class="text-xs text-gray-500">Approve or remove pending users</div>
                                </div>
                                <div id="admin-users-list" class="max-h-64 overflow-auto text-sm"></div>
                                <div class="mt-4 text-right">
                                    <button onclick="app.closeModal('modal-admin-users')" class="btn-secondary px-4 py-2 mr-2">Close</button>
                                </div>
                            </div>
                        </div>

                    <div class="glass-panel p-6">
                        <h4 class="font-bold mb-3">Deep Dive</h4>
                        <div class="text-sm text-gray-600 mb-2">จุดคุ้มทุน (คงเหลือต้องเก็บ)</div>
                        <div class="text-2xl font-bold text-gray-900 mb-4" id="deep-breakeven">0 ฿</div>
                        <div class="text-sm text-gray-600 mb-2">เป้ารวม</div>
                        <div class="text-2xl font-bold text-blue-600" id="deep-target">0 ฿</div>
                    </div>
                </div>
            </div>

            <div id="view-list" class="page-view hidden fade-in max-w-7xl mx-auto">
                <div class="glass-panel p-6 mb-6 flex gap-4 items-end">
                    <div class="flex-1">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">ค้นหา</label>
                        <input id="search-text" onkeyup="app._debouncedRender()" type="text" placeholder="ค้นหาเลขที่สัญญา หรือ ชื่อลูกค้า" class="apple-input w-full text-sm">
                    </div>
                    <div class="w-40">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">จาก</label>
                        <input id="list-start" onchange="app.renderTable()" type="date" class="apple-input w-full text-sm">
                    </div>
                    <div class="w-40">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">ถึง</label>
                        <input id="list-end" onchange="app.renderTable()" type="date" class="apple-input w-full text-sm">
                    </div>
                    <div class="w-48">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">สถานะ</label>
                        <select id="filter-status" onchange="app.renderTable()" class="apple-input w-full cursor-pointer">
                            <option value="all">ทั้งหมด</option>
                            <option value="Approved">รออนุมัติ</option>
                            <option value="Active">ในระบบ</option>
                            <option value="Closed">สิ้นสุด / ปิดบัญชี</option>
                            <option value="Cancelled">ยกเลิก</option>
                            <option value="Asset Return">คืนสินทรัพย์</option>
                        </select>
                    </div>
                    <div class="w-48">
                        <label class="text-xs font-bold text-gray-500 mb-1 block">การเงิน</label>
                        <select id="filter-finance" onchange="app.renderTable()" class="apple-input w-full cursor-pointer">
                            <option value="all">ทั้งหมด</option>
                            <option value="Paid">ปกติ</option>
                            <option value="Overdue">ค้างชำระ</option>
                        </select>
                    </div>
                </div>
                
                <!-- Action Buttons - Organized by Groups -->
                <div class="glass-panel p-4 mb-6">
                    <div class="flex flex-wrap gap-3 items-center justify-between">
                        <!-- Primary Actions -->
                        <div class="flex gap-2">
                            <button onclick="app.init()" class="btn-secondary px-4 py-2"><i class="fas fa-sync-alt mr-2"></i>Refresh</button>
                            <button onclick="app.loadMockData()" title="Load mock dataset for testing" class="btn-apple btn-primary px-4 py-2"><i class="fas fa-database mr-2"></i>Load Mock Data</button>
                        </div>
                        
                        <!-- Import/Export Group -->
                        <div class="flex gap-2">
                            <label class="btn-secondary px-4 py-2 cursor-pointer">
                                <i class="fas fa-upload mr-2"></i>Import CSV
                                <input type="file" id="csv-input" accept=".csv" class="hidden" onchange="app.importCSV(event)">
                            </label>
                            <button onclick="app.exportFilteredCSV()" class="btn-secondary px-4 py-2"><i class="fas fa-file-csv mr-2"></i>Export CSV</button>
                            <button onclick="app.exportFilteredExcel()" class="btn-secondary px-4 py-2"><i class="fas fa-file-excel mr-2"></i>Export Excel</button>
                            <a href="csv/template-contracts.csv" class="btn-secondary px-4 py-2" onclick="app.downloadTemplate(event)" rel="noopener noreferrer"><i class="fas fa-download mr-2"></i>Template</a>
                        </div>
                        
                        <!-- Data Management -->
                        <div class="flex gap-2">
                            <button onclick="app.clearData()" class="btn-secondary px-4 py-2 text-red-600 hover:bg-red-50"><i class="fas fa-trash mr-2"></i>Reset Data</button>
                        </div>
                    </div>
                </div>

                <div id="csv-preview" class="glass-panel p-4 mb-6 hidden">
                    <div class="flex justify-between items-center mb-3">
                        <div class="text-sm font-bold">CSV Preview</div>
                        <div>
                            <button onclick="app.confirmImport()" class="btn-apple btn-primary px-4 py-1 mr-2">Import</button>
                            <button onclick="$('#csv-preview').addClass('hidden'); app._csvBuffer = null;" class="btn-secondary px-3 py-1">ยกเลิก</button>
                        </div>
                    </div>
                    <div id="csv-preview-table" class="overflow-auto max-h-56 text-xs text-gray-700"></div>
                </div>

                <div class="glass-panel overflow-hidden">
                    <!-- Mantine-style DataTable with scrollable container -->
                    <div class="datatables pagination-padding">
                        <div class="whitespace-nowrap table-hover invoice-table">
                            <div class="scroll-area-root" style="position: relative;">
                                <div class="scroll-area-viewport" style="overflow: scroll;">
                                    <div style="min-width: 100%; display: table;">
                                        <table class="w-full text-left text-sm table-hover">
                                            <thead class="bg-gray-50 text-gray-500 uppercase text-[10px] font-bold border-b border-gray-200 sticky top-0">
                                                <tr>
                                                    <th class="px-6 py-4">สถานะ</th>
                                                    <th class="px-6 py-4">เลขที่สัญญา</th>
                                                    <th class="px-6 py-4">ลูกค้า</th>
                                                    <th class="px-6 py-4">เบอร์โทร</th>
                                                    <th class="px-6 py-4">วันที่เริ่ม</th>
                                                    <th class="px-6 py-4">ยอดรวม</th>
                                                    <th class="px-6 py-4">ชำระแล้ว</th>
                                                    <th class="px-6 py-4">ค้างชำระ</th>
                                                    <th class="px-6 py-4 text-right">ยอดคงเหลือ</th>
                                                    <th class="px-6 py-4 text-center">การดำเนินการ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="table-body" class="divide-y divide-gray-100 bg-white/50"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-assets" class="page-view hidden fade-in max-w-7xl mx-auto">
                <div class="glass-panel p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-gray-800" id="asset-title">รายการสินทรัพย์</h3>
                        <div class="flex items-center gap-3">
                            <select id="asset-filter" onchange="app.renderAssets(this.value)" class="apple-input text-sm">
                                <option value="assets-leased">เครื่องในระบบผ่อน</option>
                                <option value="assets-stock">STOCK (รับคืน)</option>
                            </select>
                            <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-bold" id="asset-count">0</span>
                        </div>
                    </div>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-orange-50 text-orange-800 uppercase text-[10px] font-bold">
                            <tr>
                                <th class="px-6 py-3 rounded-l-lg">รหัสทรัพย์</th>
                                <th class="px-6 py-3">รุ่นสินค้า</th>
                                <th class="px-6 py-3">สถานะ</th>
                                <th class="px-6 py-3 text-right">ต้นทุน</th>
                                <th class="px-6 py-3 text-right rounded-r-lg">ราคาประเมิน</th>
                            </tr>
                        </thead>
                        <tbody id="table-assets" class="divide-y divide-gray-100 bg-white/50"></tbody>
                    </table>
                </div>
            </div>

            <div id="view-receipts" class="page-view hidden fade-in max-w-4xl mx-auto">
                <div class="glass-panel p-8">
                    <h3 class="text-xl font-bold text-gray-900 mb-6 border-b pb-4">ตั้งค่าใบเสร็จรับเงิน</h3>
                    <div class="grid grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase block mb-1">ชื่อบริษัท</label>
                                <input type="text" id="rcpt-company-name" class="apple-input w-full" value="บริษัท ที แอสเซท แมเนจเม้นท์ จำกัด">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase block mb-1">ที่อยู่</label>
                                <textarea id="rcpt-company-address" class="apple-input w-full h-24">123/45 อาคารทีพลัส ชั้น 9 ถนนสุขุมวิท แขวงคลองตัน เขตคลองเตย กรุงเทพฯ 10110</textarea>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase block mb-1">เลขประจำตัวผู้เสียภาษี</label>
                                <input type="text" id="rcpt-tax-id" class="apple-input w-full" value="010556XXXXXXX">
                            </div>
                        </div>
                        <div class="bg-gray-100 rounded-2xl p-6 flex flex-col justify-center items-center text-center">
                            <p class="text-xs text-gray-500 uppercase mb-2">Format เลขที่ใบเสร็จ</p>
                            <p class="text-2xl font-mono font-bold text-blue-600" id="rcp-preview">AMC-XXXX</p>
                            <p class="text-xs text-orange-500 mt-2 bg-orange-100 px-2 py-1 rounded">* รันเลขใหม่ทุกเดือน (ตามที่ร้องขอ)</p>
                            <div class="mt-4 p-4 border rounded-lg bg-white w-full text-left text-xs">
                                <h5 class="font-bold mb-2">ตัวอย่างใบเสร็จ</h5>
                                <div id="receipt-template-preview" class="space-y-1 text-gray-600">
                                    <p><strong>ผู้รับเงิน:</strong> <span id="preview-company-name"></span></p>
                                    <p><strong>ที่อยู่:</strong> <span id="preview-company-address"></span></p>
                                    <p><strong>เลขประจำตัว:</strong> <span id="preview-tax-id"></span></p>
                                    <hr class="my-2">
                                    <p><strong>เลขที่:</strong> <span id="preview-rcpt-no"></span></p>
                                    <p><strong>ลูกค้า:</strong> สมชาย ใจดี</p>
                                    <p><strong>สำหรับสัญญา:</strong> C-1001</p>
                                    <p><strong>จำนวน:</strong> 500.00 บาท</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 text-right">
                        <button onclick="app.saveReceiptSettings()" class="btn-apple btn-primary px-6 py-2 shadow-lg">บันทึกการตั้งค่า</button>
                    </div>
                </div>
            </div>

            <!-- User Management View -->
            <div id="view-users" class="page-view hidden fade-in max-w-6xl mx-auto">
                <div class="glass-panel p-8">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h3 class="text-2xl font-bold mb-1">จัดการผู้ใช้งาน</h3>
                            <p class="text-sm text-gray-500">เพิ่ม แก้ไข หรือลบบัญชีผู้ใช้ในระบบ</p>
                        </div>
                        <button onclick="app.addNewUser()" class="btn-apple btn-primary px-4 py-2">
                            <i class="fas fa-plus mr-2"></i> เพิ่มผู้ใช้
                        </button>
                    </div>
                    <div id="users-table-container"></div>
                </div>
            </div>

            <!-- Financial Reports View -->
            <div id="view-reports" class="page-view hidden fade-in max-w-7xl mx-auto">
                <div class="glass-panel p-8">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold">รายงานการเงิน</h3>
                        <div class="flex gap-2">
                            <select id="report-filter-status" onchange="app.renderReports()" class="apple-input text-sm">
                                <option value="">ทุกสถานะ</option>
                                <option value="Active">อยู่ในระบบ</option>
                                <option value="Approved">รออนุมัติ</option>
                                <option value="Closed">สิ้นสุด</option>
                            </select>
                            <button onclick="app.exportReports()" class="btn-apple btn-primary px-4 py-2">
                                <i class="fas fa-download mr-2"></i>Export
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary with Status Breakdown -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-2xl border border-green-200">
                            <p class="text-xs text-green-700 uppercase font-bold mb-1">รายรับทั้งหมด</p>
                            <h3 class="text-2xl font-bold text-green-600" id="report-total-income">0 ฿</h3>
                            <p class="text-xs text-green-600 mt-2" id="report-income-detail"></p>
                        </div>
                        <div class="bg-gradient-to-br from-red-50 to-red-100 p-4 rounded-2xl border border-red-200">
                            <p class="text-xs text-red-700 uppercase font-bold mb-1">ยอดค้างรับ</p>
                            <h3 class="text-2xl font-bold text-red-600" id="report-pending">0 ฿</h3>
                            <p class="text-xs text-red-600 mt-2" id="report-pending-detail"></p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-2xl border border-blue-200">
                            <p class="text-xs text-blue-700 uppercase font-bold mb-1">สัญญาทั้งหมด</p>
                            <h3 class="text-2xl font-bold text-blue-600" id="report-total-contracts">0</h3>
                            <p class="text-xs text-blue-600 mt-2" id="report-contracts-detail"></p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-2xl border border-purple-200">
                            <p class="text-xs text-purple-700 uppercase font-bold mb-1">สถานะสัญญา</p>
                            <div id="report-status-summary" class="text-xs text-purple-700 mt-2 space-y-1"></div>
                        </div>
                    </div>

                    <!-- Payment Details Table -->
                    <div class="bg-white rounded-2xl border p-6">
                        <h4 class="font-bold text-lg mb-4">รายละเอียดการชำระเงิน</h4>
                        <div id="report-payment-table" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>

            <!-- Customers / CRM view -->
            <div id="view-customers" class="page-view hidden fade-in max-w-4xl mx-auto">
                <div class="glass-panel p-6 text-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h3 class="text-lg font-bold mb-1">ลูกค้า</h3>
                            <p class="text-sm text-gray-500">รายชื่อลูกค้าที่มีสัญญา (จัดกลุ่มตามชื่อและเบอร์โทร) • Call Logging & ประวัติการติดต่อ</p>
                            <p class="text-xs text-orange-600 mt-1"><i class="fas fa-info-circle"></i> ข้อมูลนี้สร้างจากสัญญาในระบบ ไม่ใช่ฐาน CRM แยกต่างหาก</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="cust-search" oninput="app.renderCustomers(this.value)" type="text" placeholder="ค้นหาชื่อลูกค้า หรือ เบอร์โทร" class="apple-input text-sm" />
                            <button onclick="app.exportAllCustomers()" class="btn-secondary px-3 py-2 text-sm">Export All</button>
                        </div>
                    </div>
                    <div class="mt-2" id="customers-list">
                        <div class="p-4 bg-white rounded-xl border">ไม่มีข้อมูลตัวอย่าง</div>
                    </div>
                </div>
            </div>

            <div id="view-detail" class="page-view hidden fade-in pb-20 max-w-7xl mx-auto">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-2">
                        <button onclick="app.navTo('list')" class="btn-secondary px-4 py-2 text-xs flex items-center gap-2"><i class="fas fa-chevron-left"></i> กลับ</button>
                        <div class="glass-panel p-1 flex gap-1">
                            <button onclick="app.skipTo('section-customer')" class="px-4 py-1.5 rounded-lg text-xs font-bold text-gray-600 hover:bg-white/50">ข้อมูลลูกค้า</button>
                            <button onclick="app.skipTo('section-asset')" class="px-4 py-1.5 rounded-lg text-xs font-bold text-gray-600 hover:bg-white/50">สินทรัพย์</button>
                            <button onclick="app.skipTo('section-installment')" class="px-4 py-1.5 rounded-lg text-xs font-bold text-gray-600 hover:bg-white/50">ตารางผ่อน</button>
                            <button onclick="app.skipTo('section-calllogs')" class="px-4 py-1.5 rounded-lg text-xs font-bold text-gray-600 hover:bg-white/50">Call Logs</button>
                            <button onclick="app.skipTo('section-timeline')" class="px-4 py-1.5 rounded-lg text-xs font-bold text-gray-600 hover:bg-white/50">Timeline</button>
                        </div>
                    </div>
                    <div>
                        <span id="det-status" class="badge bg-gray-100 text-gray-500 px-2 py-1 rounded text-[10px] font-bold uppercase">STATUS</span>
                    </div>
                </div>

                <!-- Customer Information Section -->
                <div id="section-customer" class="glass-panel p-6 mb-6">
                    <h3 class="font-bold text-xl text-gray-900 mb-4 border-b pb-2"><i class="fas fa-user mr-2"></i>ข้อมูลลูกค้า</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">ชื่อ-สกุล</p>
                            <p class="text-base font-bold" id="det-name">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">เลขที่สัญญา</p>
                            <p class="text-base font-mono font-bold" id="det-id">C-XXXX</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">เลขบัตรประชาชน</p>
                            <p class="text-base font-mono" id="det-national-id">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">เบอร์โทรศัพท์</p>
                            <p class="text-base font-mono" id="det-phone">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">เบอร์โทรอ้างอิง</p>
                            <p class="text-base font-mono" id="det-phone-ref">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">วันที่ทำสัญญา</p>
                            <p class="text-base" id="det-date">-</p>
                        </div>
                        <div class="md:col-span-3">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">ที่อยู่ติดต่อ</p>
                            <p class="text-sm" id="det-address">-</p>
                        </div>
                        <div class="md:col-span-3">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">ที่อยู่ที่ทำงาน</p>
                            <p class="text-sm" id="det-address-work">-</p>
                        </div>
                        <div class="md:col-span-3">
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">ที่อยู่ตามบัตรประชาชน</p>
                            <p class="text-sm" id="det-address-idcard">-</p>
                        </div>
                    </div>
                </div>

                <!-- Asset Information Section -->
                <div id="section-asset" class="glass-panel p-6 mb-6">
                    <h3 class="font-bold text-xl text-gray-900 mb-4 border-b pb-2"><i class="fas fa-mobile-alt mr-2"></i>ข้อมูลสินทรัพย์</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">รุ่นสินค้า</p>
                            <p class="text-base font-bold" id="det-asset-model">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">ความจุ</p>
                            <p class="text-base" id="det-asset-capacity">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">IMEI / Serial</p>
                            <p class="text-base font-mono" id="det-asset-imei">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">ต้นทุนสินค้า</p>
                            <p class="text-base font-bold text-orange-600" id="det-asset-cost">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">เงินดาวน์</p>
                            <p class="text-base font-bold text-green-600" id="det-down-payment">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">ค่างวด/เดือน</p>
                            <p class="text-base font-bold text-blue-600" id="det-monthly-payment">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">งวดที่ชำระครั้งแรก</p>
                            <p class="text-base" id="det-first-installment">-</p>
                        </div>
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold mb-1">จำนวนงวด</p>
                            <p class="text-base" id="det-installments">-</p>
                        </div>
                    </div>
                </div>

                <!-- Payment Progress -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-lg text-gray-900 mb-4"><i class="fas fa-chart-line mr-2"></i>ความคืบหน้าการชำระ</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">ยอดรวม</span>
                                <span class="text-lg font-bold" id="det-total">0 ฿</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">ชำระแล้ว</span>
                                <span class="text-lg font-bold text-green-600" id="det-paid">0 ฿</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">ยอดคงเหลือ</span>
                                <span class="text-lg font-bold text-red-600" id="det-balance">0 ฿</span>
                            </div>
                            <div class="mt-3">
                                <div class="w-full bg-gray-200 rounded-full h-6 overflow-hidden">
                                    <div id="payment-progress-bar" class="h-6 bg-gradient-to-r from-blue-400 to-blue-600 flex items-center justify-center text-white text-xs font-bold"></div>
                                </div>
                                <p class="text-xs text-gray-500 mt-2 text-center">ชำระแล้ว <span id="payment-percent">0%</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-lg text-gray-900 mb-4"><i class="fas fa-cog mr-2"></i>จัดการสัญญา</h3>
                        <div class="space-y-2">
                            <button onclick="app.openPaymentModal()" class="btn-apple btn-primary w-full py-3"><i class="fas fa-credit-card mr-2"></i>ชำระเงิน</button>
                            <button onclick="app.updateStatus('Closed')" class="btn-secondary w-full py-2 text-xs hover:bg-gray-100">ปิดบัญชี (Closed)</button>
                            <button onclick="app.updateStatus('Asset Return')" class="btn-secondary w-full py-2 text-xs hover:bg-orange-50 hover:text-orange-600">คืนสินทรัพย์ (Asset Return)</button>
                            <button onclick="app.updateStatus('Cancelled')" class="btn-secondary w-full py-2 text-xs hover:bg-red-50 hover:text-red-600">ยกเลิกสัญญา (Cancelled)</button>
                        </div>
                    </div>
                </div>

                <!-- Installment Schedule Table -->
                <div id="section-installment" class="glass-panel p-6 mb-6">
                    <h3 class="font-bold text-xl text-gray-900 mb-4 border-b pb-2"><i class="fas fa-calendar-alt mr-2"></i>ตารางการผ่อนชำระ</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-blue-50 text-blue-800">
                                <tr>
                                    <th class="px-4 py-3 text-left font-bold">งวดที่</th>
                                    <th class="px-4 py-3 text-left font-bold">วันที่กำหนดชำระ</th>
                                    <th class="px-4 py-3 text-right font-bold">จำนวนเงิน</th>
                                    <th class="px-4 py-3 text-left font-bold">วันที่ชำระจริง</th>
                                    <th class="px-4 py-3 text-center font-bold">สถานะ</th>
                                </tr>
                            </thead>
                            <tbody id="installment-schedule-body" class="divide-y divide-gray-100">
                                <tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">ไม่มีข้อมูลตารางผ่อน</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Call Logs Section -->
                <div id="section-calllogs" class="glass-panel p-6 mb-6">
                    <div class="flex justify-between items-center mb-4 border-b pb-2">
                        <h3 class="font-bold text-xl text-gray-900"><i class="fas fa-phone mr-2"></i>Call Logs (บันทึกการติดตาม)</h3>
                        <button onclick="app.addCallLog()" class="btn-apple btn-primary px-4 py-2"><i class="fas fa-plus mr-2"></i>เพิ่ม Call Log</button>
                    </div>
                    <div id="call-logs-list" class="space-y-3">
                        <p class="text-gray-400 text-center py-8">ยังไม่มีบันทึกการโทร</p>
                    </div>
                </div>

                <!-- Attachments Section -->
                <div class="glass-panel p-6 mb-6">
                    <h3 class="font-bold text-xl text-gray-900 mb-4 border-b pb-2"><i class="fas fa-paperclip mr-2"></i>ไฟล์แนบ</h3>
                    <div id="attachments" class="space-y-2">
                        <p class="text-xs text-gray-400">ยังไม่มีไฟล์แนบ</p>
                        <div class="mt-2">
                            <label class="btn-secondary inline-block px-4 py-2 cursor-pointer">
                                <i class="fas fa-upload mr-2"></i>แนบไฟล์
                                <input type="file" class="hidden attach-file-input" onchange="app.addAttachment(event)">
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Timeline Section -->
                <div id="section-timeline" class="glass-panel p-6 mb-6">
                    <h3 class="font-bold text-xl text-gray-900 mb-4 border-b pb-2"><i class="fas fa-history mr-2"></i>Timeline (ประวัติการทำรายการ)</h3>
                    <div class="flex gap-3 mb-6">
                        <input type="text" id="timeline-input" class="apple-input flex-1 text-sm" placeholder="เพิ่มบันทึก...">
                        <button onclick="app.addTimeline()" class="btn-apple btn-primary px-6">เพิ่ม</button>
                    </div>
                    <div class="space-y-3" id="timeline-feed">
                        <p class="text-gray-400 text-center py-4">ยังไม่มีประวัติ</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="modal-payment" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/40 backdrop-blur-md fade-in">
        <div class="bg-white w-full max-w-md rounded-[2rem] shadow-2xl p-8 transform scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">ชำระเงิน</h3>
                <button onclick="app.closeModal('modal-payment')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-5">
                <div class="flex justify-between items-center bg-blue-50 px-4 py-3 rounded-2xl border border-blue-100">
                    <div><p class="text-[10px] text-blue-600 font-bold uppercase">ยอดคงเหลือ</p><h4 class="text-lg font-bold text-gray-900" id="pay-modal-balance">0</h4></div>
                    <span class="text-[10px] text-orange-600 bg-orange-100 px-3 py-1 rounded-full font-bold border border-orange-200">Fee 100.-</span>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <div onclick="app.setPayType('min')" class="pay-option p-3 rounded-xl text-center border" id="btn-min"><div class="font-bold text-xs">ขั้นต่ำ</div><div class="text-[10px] text-gray-500">500.-</div></div>
                    <div onclick="app.setPayType('bill')" class="pay-option p-3 rounded-xl text-center border" id="btn-bill"><div class="font-bold text-xs">ตามบิล</div><div class="text-[10px] text-blue-500 font-bold" id="lbl-installment">-</div></div>
                    <div onclick="app.setPayType('close')" class="pay-option p-3 rounded-xl text-center border" id="btn-close"><div class="font-bold text-xs">ปิดบัญชี</div><div class="text-[10px] text-gray-500">ลดพิเศษ</div></div>
                </div>
                <input type="hidden" id="pay-type" value="min">

                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-gray-400 font-bold">฿</span>
                    <input type="number" id="pay-amount" class="apple-input w-full text-2xl font-bold text-right pr-4 text-blue-600 bg-gray-50" placeholder="0.00">
                </div>

                <div id="div-discount" class="hidden bg-gray-50 p-3 rounded-xl">
                    <label class="text-xs font-bold text-gray-500 mb-1 block">ส่วนลด (%)</label>
                    <select id="pay-discount" onchange="app.calcCloseAmount()" class="apple-input w-full text-sm bg-white"><option value="0">ไม่มี</option><option value="0.05">5%</option><option value="0.10">10%</option></select>
                </div>

                <label class="flex items-center gap-3 p-3 border rounded-xl cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" id="req-receipt" class="w-4 h-4 text-blue-600 rounded">
                    <span class="text-sm font-medium text-gray-700">ขอใบเสร็จรับเงิน (E-Receipt)</span>
                </label>

                <div class="grid grid-cols-2 gap-3">
                    <input type="date" class="apple-input w-full text-xs" id="pay-date">
                    <div class="relative"><input type="file" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"><div class="apple-input w-full text-xs text-center text-gray-400 flex justify-center gap-2"><i class="fas fa-upload"></i> แนบสลิป</div></div>
                </div>

                <button onclick="app.submitPayment()" class="w-full btn-apple btn-primary py-3.5 shadow-lg text-sm">ยืนยันการชำระ</button>
            </div>
        </div>
    </div>

    <div id="modal-approve" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/40 backdrop-blur-md fade-in">
        <div class="bg-white w-full max-w-sm p-8 rounded-3xl shadow-2xl text-center">
            <div class="w-14 h-14 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto text-2xl mb-4"><i class="fas fa-check"></i></div>
            <h3 class="text-xl font-bold text-gray-900">ยืนยันการอนุมัติ</h3>
            <p class="text-xs text-gray-500 mb-6">กรุณากรอกรหัสผ่าน Admin (1234)</p>
            <input type="password" id="approve-pass" class="apple-input w-full text-center mb-6 text-lg tracking-widest bg-gray-50" placeholder="••••••">
            <div class="flex gap-3">
                <button onclick="app.closeModal('modal-approve')" class="flex-1 btn-secondary py-2.5">ยกเลิก</button>
                <button onclick="app.confirmApprove()" class="flex-1 btn-apple btn-primary py-2.5 bg-green-600 shadow-lg">ยืนยัน</button>
            </div>
        </div>
    </div>

    <div id="modal-attachment" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-4">
            <div class="flex justify-between items-center mb-3">
                <h4 id="att-title" class="font-bold">Preview</h4>
                <button onclick="app.closeModal('modal-attachment')" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div id="att-body" class="min-h-[320px] flex items-center justify-center overflow-auto"></div>
        </div>
    </div>

    <div id="modal-customer" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl rounded-2xl shadow-2xl p-6 max-h-[90vh] overflow-auto">
            <div class="flex justify-between items-center mb-4 sticky top-0 bg-white pb-3 border-b">
                <h4 id="cust-title" class="font-bold text-lg">รายการสัญญาของลูกค้า</h4>
                <button onclick="app.closeModal('modal-customer')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="cust-body" class="text-sm">
                <!-- filled dynamically by openCustomer() -->
            </div>
            <div class="mt-4 pt-4 border-t flex justify-between items-center">
                <div class="text-xs text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    คลิก "Open" เพื่อดูรายละเอียดสัญญาแบบเต็ม
                </div>
                <div class="flex gap-2">
                    <button onclick="app.exportCustomerContracts()" class="btn-secondary px-4 py-2 text-sm">
                        <i class="fas fa-download mr-2"></i>Export CSV
                    </button>
                    <button onclick="app.closeModal('modal-customer')" class="btn-apple btn-primary px-4 py-2 text-sm">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings modal for upload token -->
    <div id="modal-settings" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md rounded-2xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-bold">Settings</h4>
                <button onclick="app.closeModal('modal-settings')" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <label class="text-xs font-bold text-gray-500">Upload Token (optional)</label>
                <input id="upload-token" type="text" class="apple-input w-full text-sm" placeholder="Paste upload token to enable protected uploads" />
                <div class="text-xs text-gray-400">If a token is set here, the client will send it as header <code>x-upload-token</code> on uploads.</div>
                <div>
                    <label class="text-xs font-bold text-gray-500">Yalecom call template (optional)</label>
                    <input id="setting-yalecom" type="text" class="apple-input w-full text-sm" placeholder="e.g. yalecom://call?to=%s" />
                    <div class="text-xs text-gray-400">Use <code>%s</code> to inject phone number. If empty, the app will use <code>tel:</code>.</div>
                </div>
                <div class="mt-4 text-right">
                    <button onclick="app.saveSettings()" class="btn-apple btn-primary px-4 py-2">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Change Logs modal -->
    <div id="modal-status-logs" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-bold">Status Change Logs</h4>
                <button onclick="app.closeModal('modal-status-logs')" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="mb-3 text-xs text-gray-500">บันทึกการเปลี่ยนสถานะสัญญา (localStorage)</div>
            <div id="status-logs-list" class="max-h-64 overflow-auto text-sm border rounded p-2 bg-gray-50"></div>
            <div class="mt-4 text-right">
                <button onclick="app.clearStatusLogs()" class="btn-secondary px-4 py-2 mr-2">Clear Logs</button>
                <button onclick="app.closeModal('modal-status-logs')" class="btn-apple btn-primary px-4 py-2">Close</button>
            </div>
        </div>
    </div>
        </div>
    </div>

        <!-- Call Logs modal -->
        <div id="modal-call-logs" class="fixed inset-0 z-[9999] hidden items-center justify-center bg-black/50 backdrop-blur-sm">
            <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-bold">Call Logs</h4>
                    <button onclick="app.closeModal('modal-call-logs')" class="text-gray-500"><i class="fas fa-times"></i></button>
                </div>
                <div class="mb-3 text-xs text-gray-500">บันทึกการโทรล่าสุด (เก็บที่ localStorage)</div>
                <div id="call-logs-list" class="max-h-64 overflow-auto text-sm border rounded p-2 bg-gray-50"></div>
                <div class="mt-4 text-right">
                    <button onclick="app.clearCallLogs()" class="btn-secondary px-4 py-2 mr-2">Clear Logs</button>
                    <button onclick="app.closeModal('modal-call-logs')" class="btn-apple btn-primary px-4 py-2">Close</button>
                </div>
            </div>
        </div>

    <script>
        const app = {
            storageKey: 'tms_contracts_v1',
            sessionKey: 'tms_session',
            usersKey: 'tms_users',
            data: { contracts: [], assets: [], receiptCounter: 1, currentId: null },
            currentUser: null,

            init: function() {
                // Check authentication first
                if (!this.checkAuth()) {
                    document.body.classList.add('logged-out');
                    document.body.classList.remove('logged-in');
                    return; // Don't initialize app if not logged in
                }

                // User is authenticated, show app
                document.body.classList.add('logged-in');
                document.body.classList.remove('logged-out');
                this.updateUserDisplay();

                // load from localStorage if available (migrated schema supports {contracts, assets})
                const saved = localStorage.getItem(this.storageKey);
                if(saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        // backwards compatibility: older storage may be array of contracts
                        if(Array.isArray(parsed)) { this.data.contracts = parsed; }
                        else { this.data.contracts = parsed.contracts || []; this.data.assets = parsed.assets || []; }
                    } catch(e) { this.data.contracts = []; this.data.assets = []; }
                }

                if(!this.data.contracts || this.data.contracts.length === 0) {
                    this.data.contracts = [
                    { id: 'C-1001', name: 'สมชาย ใจดี', phone: '081-111-2222', date: '2024-01-15', status: 'Active', total: 35000, paid: 15000, before: 5000, installments: 12, payments: [], fee_paid: false, cost: 20000, resale: 0 },
                    { id: 'C-1002', name: 'วิภา รักเรียน', phone: '089-222-3333', date: '2023-05-20', status: 'Active', total: 20000, paid: 5000, before: 0, installments: 10, payments: [], fee_paid: true, cost: 10000, resale: 0 },
                    { id: 'C-1003', name: 'กล้าหาญ ชาญชัย', phone: '090-555-5555', date: '2025-02-18', status: 'Approved', total: 42000, paid: 0, before: 0, installments: 12, payments: [], fee_paid: false, cost: 22000, resale: 0 },
                    { id: 'C-1004', name: 'มานี มีทรัพย์', phone: '061-444-3333', date: '2023-10-10', status: 'Asset Return', total: 15000, paid: 2000, before: 1000, installments: 6, payments: [], fee_paid: true, cost: 12000, resale: 10000 }
                    ];
                    // generate assets list from contracts for initial demo
                    this.data.assets = [];
                    this.data.contracts.forEach(c => {
                        const ast = { assetId: c.id + '-AST', contractId: c.id, model: 'iPhone 15 Pro', status: c.status === 'Asset Return' ? 'stock' : 'leased', cost: c.cost||0, resale: c.resale||0 };
                        this.data.assets.push(ast);
                    });
                    this.saveData();
                }
                
                const today = new Date().toISOString().slice(0,10);
                $('#pay-date').val(today);
                $('#rcp-preview').text(`AMC-${today.replace(/-/g,'')}-XXXX`);
                // load client upload token from localStorage (if set via settings)
                try{
                    const t = localStorage.getItem('upload_token');
                    if(t && t.length) window.UPLOAD_TOKEN = t;
                }catch(e){}
                this.initCharts();
                this.renderDashboard();
                this.renderTable();
                this.renderCustomers();
                // mark app ready for automated tests
                try{ window.APP_READY = true; console.log('APP_READY'); }catch(e){}
                this.loadReceiptSettings();
            },

            // Authentication Functions
            checkAuth: function() {
                try {
                    const session = localStorage.getItem(this.sessionKey);
                    if (!session) return false;
                    
                    const sessionData = JSON.parse(session);
                    const now = new Date().getTime();
                    
                    // Check if session expired (24 hours)
                    if (sessionData.expires && sessionData.expires < now) {
                        localStorage.removeItem(this.sessionKey);
                        return false;
                    }
                    
                    this.currentUser = sessionData.user;
                    return true;
                } catch (e) {
                    return false;
                }
            },

            handleLogin: function(event) {
                event.preventDefault();
                
                const username = $('#login-username').val().trim();
                const password = $('#login-password').val();
                const remember = $('#remember-me').is(':checked');
                
                // Initialize default users if not exist
                this.initializeUsers();
                
                // Validate credentials
                const users = JSON.parse(localStorage.getItem(this.usersKey) || '[]');
                const user = users.find(u => u.username === username && u.password === password);
                
                if (!user) {
                    $('#login-error').removeClass('hidden');
                    $('#login-error-msg').text('Invalid username or password');
                    $('#login-password').val('').focus();
                    return false;
                }
                
                // Create session
                const sessionData = {
                    user: {
                        username: user.username,
                        displayName: user.displayName || user.username,
                        role: user.role || 'user'
                    },
                    expires: remember ? null : new Date().getTime() + (24 * 60 * 60 * 1000), // 24 hours
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem(this.sessionKey, JSON.stringify(sessionData));
                this.currentUser = sessionData.user;
                
                // Hide login screen, show app
                document.body.classList.remove('logged-out');
                document.body.classList.add('logged-in');
                
                // Initialize app
                this.init();
                
                return false;
            },

            logout: function() {
                Swal.fire({
                    title: 'ออกจากระบบ?',
                    text: 'คุณต้องการออกจากระบบหรือไม่?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'ออกจากระบบ',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#ef4444'
                }).then((result) => {
                    if (result.isConfirmed) {
                        localStorage.removeItem(this.sessionKey);
                        this.currentUser = null;
                        
                        // Show login screen
                        document.body.classList.remove('logged-in');
                        document.body.classList.add('logged-out');
                        
                        // Clear form
                        $('#login-username').val('');
                        $('#login-password').val('');
                        $('#login-error').addClass('hidden');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'ออกจากระบบสำเร็จ',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            },

            updateUserDisplay: function() {
                if (!this.currentUser) return;
                
                const displayName = this.currentUser.displayName || this.currentUser.username;
                const initial = displayName.charAt(0).toUpperCase();
                
                $('#user-display-name').text(displayName);
                $('#user-avatar').text(initial);
            },

            initializeUsers: function() {
                const existing = localStorage.getItem(this.usersKey);
                if (existing) return;
                
                // Create default admin user
                const defaultUsers = [
                    {
                        username: 'admin',
                        password: 'admin1234',
                        displayName: 'Administrator',
                        role: 'admin'
                    },
                    {
                        username: 'user',
                        password: 'user1234',
                        displayName: 'Staff User',
                        role: 'user'
                    }
                ];
                
                localStorage.setItem(this.usersKey, JSON.stringify(defaultUsers));
            },

            saveData: function(){
                try { localStorage.setItem(this.storageKey, JSON.stringify({ contracts: this.data.contracts, assets: this.data.assets })); } catch(e) { console.warn('save failed', e); }
            },

            clearData: function(){
                if(!confirm('รีเซ็ตข้อมูล ตัวอย่างและลบข้อมูลที่บันทึกไว้?')) return;
                localStorage.removeItem(this.storageKey);
                location.reload();
            },

            navTo: function(page, el, filter) {
                if(el) { $('.menu-item').removeClass('active'); $(el).addClass('active'); }
                $('.page-view').addClass('hidden');
                
                if(page === 'dashboard') { 
                    $('#view-dashboard').removeClass('hidden'); 
                    $('#page-title').text('Overview'); 
                    this.renderDashboard(); 
                }
                else if (page === 'list') { 
                    $('#view-list').removeClass('hidden'); 
                    $('#page-title').text('รายการสัญญา');
                    // Set filter - empty string means show all
                    $('#filter-status').val(filter || ''); 
                    this.renderTable(); 
                }
                else if (page.startsWith('assets')) { 
                    $('#view-assets').removeClass('hidden'); 
                    $('#page-title').text('สินทรัพย์');
                    this.renderAssets(page); 
                }
                else if (page === 'customers') { 
                    $('#view-customers').removeClass('hidden'); 
                    $('#page-title').text('ลูกค้า (CRM)'); 
                    this.renderCustomers(); 
                }
                else if (page === 'users') {
                    $('#view-users').removeClass('hidden');
                    $('#page-title').text('จัดการผู้ใช้');
                    this.renderUsers();
                }
                else if (page === 'reports') {
                    $('#view-reports').removeClass('hidden');
                    $('#page-title').text('รายงานการเงิน');
                    this.renderReports();
                }
                else if (page === 'receipts') {
                    $('#view-receipts').removeClass('hidden');
                    $('#page-title').text('ตั้งค่าใบเสร็จ');
                    this.loadReceiptSettings();
                }
                else { 
                    $('#view-' + page).removeClass('hidden'); 
                    $('#page-title').text('System'); 
                }
            },
            
            scrollTo: function(id) { document.getElementById(id).scrollIntoView({behavior:'smooth', block:'center'}); },
            toggleSub: function(id) { 
                const el = document.getElementById(id);
                if (!el) return;
                if (el.classList.contains('hidden')) {
                    el.classList.remove('hidden');
                } else {
                    el.classList.add('hidden');
                }
            },
            openModal: function(id) { $('#'+id).removeClass('hidden').addClass('flex'); },
            closeModal: function(id) { $('#'+id).addClass('hidden').removeClass('flex'); },

            calcOverdue: function(dateStr, status) {
                if(!dateStr || status !== 'Active') return { text:'ปกติ', isOverdue:false, days:0 };
                const start = new Date(dateStr);
                const now = new Date();
                const diff = Math.floor((now - start)/(1000*60*60*24));
                if(diff <= 30) return { text: `${diff} วัน`, isOverdue:false, days: diff };
                const years = Math.floor(diff / 365);
                let rem = diff % 365;
                const months = Math.floor(rem / 30);
                const days = rem % 30;
                const parts = [];
                if(years) parts.push(`${years} ปี`);
                if(months) parts.push(`${months} เดือน`);
                if(days) parts.push(`${days} วัน`);
                return { text: `${parts.join(' ')}`, isOverdue:true, days: diff };
            },

            renderDashboard: function() {
                const c = this.data.contracts;
                // apply optional date filter
                const s = $('#dash-start').val();
                const e = $('#dash-end').val();
                let list = c;
                if(s || e) {
                    const start = s ? new Date(s) : new Date('1970-01-01');
                    const end = e ? new Date(e) : new Date();
                    list = c.filter(x => { const d = new Date(x.date); return d >= start && d <= end; });
                }
                const paid = list.reduce((s,x)=>s+(x.paid||0),0);
                const before = list.reduce((s,x)=>s+(x.before||0),0);
                $('#d-collected').text((paid - before).toLocaleString() + ' ฿');
                $('#d-active').text(list.filter(x=>x.status==='Active').length);
                $('#d-pending').text(list.filter(x=>x.status==='Approved').length);
                $('#d-overdue').text(list.filter(x=> this.calcOverdue(x.date, x.status).isOverdue).length);
                // update charts with the filtered list
                try{ this.updateCharts(list); }catch(e){ console.warn('updateCharts failed', e); }
            },

            initCharts: function(){
                // initialize Chart.js instances
                try{
                    const el1 = document.getElementById('chart-status');
                    const el2 = document.getElementById('chart-revenue');
                    if(el1 && !this._chartStatus){
                        const ctx1 = el1.getContext('2d');
                        this._chartStatus = new Chart(ctx1, {
                            type: 'doughnut',
                            data: { labels: ['Active','Approved','Closed','Asset Return'], datasets: [{ data: [0,0,0,0], backgroundColor: ['#10B981','#3B82F6','#EF4444','#F97316'] }] },
                            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                        });
                    }
                    if(el2 && !this._chartRevenue){
                        const ctx2 = el2.getContext('2d');
                        this._chartRevenue = new Chart(ctx2, {
                            type: 'bar',
                            data: { labels: [], datasets: [{ label: 'Collected', data: [], backgroundColor: '#60A5FA' }] },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: { y: { beginAtZero: true, ticks: { callback: function(v){ return Number(v).toLocaleString(); } } } },
                                plugins: {
                                    tooltip: { callbacks: { label: function(ctx){ return '฿ ' + Number(ctx.parsed.y).toLocaleString(); } } }
                                }
                            }
                        });
                    }
                }catch(err){ console.warn('Chart init error', err); }
            },

            updateCharts: function(list){
                // update status doughnut
                list = list || this.data.contracts || [];
                const byStatus = { Active:0, Approved:0, Closed:0, 'Asset Return':0, Other:0 };
                list.forEach(c => { if(byStatus[c.status] !== undefined) byStatus[c.status]++; else byStatus.Other++; });
                if(this._chartStatus){
                    this._chartStatus.data.labels = Object.keys(byStatus);
                    this._chartStatus.data.datasets = [{ data: Object.values(byStatus), backgroundColor: ['#10B981','#3B82F6','#EF4444','#F97316','#9CA3AF'] }];
                    this._chartStatus.update();
                }

                // revenue by month (collected) — include months in selected dashboard range
                const rev = {};
                let startMonth = null, endMonth = null;
                try{
                    const s = $('#dash-start').val();
                    const e = $('#dash-end').val();
                    if(s) startMonth = new Date(s);
                    if(e) endMonth = new Date(e);
                }catch(e){}
                list.forEach(c => {
                    try{
                        const d = new Date(c.date);
                        const key = d.toISOString().slice(0,7);
                        rev[key] = (rev[key] || 0) + (Number(c.paid) || 0);
                        if(!startMonth || d < startMonth) startMonth = d;
                        if(!endMonth || d > endMonth) endMonth = d;
                    }catch(e){}
                });
                // build contiguous month labels between startMonth and endMonth
                const months = [];
                const values = [];
                if(startMonth && endMonth){
                    const cur = new Date(startMonth.getFullYear(), startMonth.getMonth(), 1);
                    const last = new Date(endMonth.getFullYear(), endMonth.getMonth(), 1);
                    while(cur <= last){
                        const key = cur.toISOString().slice(0,7);
                        months.push(key);
                        values.push(rev[key] || 0);
                        cur.setMonth(cur.getMonth()+1);
                    }
                }
                if(this._chartRevenue){
                    this._chartRevenue.data.labels = months;
                    this._chartRevenue.data.datasets = [{ label: 'Collected', data: values, backgroundColor: '#60A5FA' }];
                    this._chartRevenue.update();
                }

                // update deep dive metrics
                const collected = list.reduce((s,x)=>s+(Number(x.paid)||0),0);
                const before = list.reduce((s,x)=>s+(Number(x.before)||0),0);
                $('#deep-breakeven').text((collected - before).toLocaleString() + ' ฿');
                $('#deep-target').text((list.reduce((s,x)=>s+(Number(x.total)||0),0)).toLocaleString() + ' ฿');
            },

            _downloadBlob: function(filename, blob){
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename; document.body.appendChild(a); a.click();
                setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 5000);
            },

            exportFilteredCSV: function(){
                const list = this._lastFilteredList && this._lastFilteredList.length ? this._lastFilteredList : this.data.contracts;
                if(!list || list.length === 0){ Swal.fire({ icon: 'info', title: 'ไม่มีข้อมูลเพื่อส่งออก' }); return; }
                const headers = ['id','name','phone','date','status','total','paid','installments','cost','resale','planType'];
                const rows = [headers.join(',')];
                list.forEach(r => {
                    const vals = headers.map(h => {
                        const v = r[h] === undefined || r[h] === null ? '' : String(r[h]).replace(/"/g,'""');
                        return `"${v}"`;
                    });
                    rows.push(vals.join(','));
                });
                const csv = rows.join('\n');
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                this._downloadBlob('contracts_export.csv', blob);
            },

            exportFilteredExcel: function(){
                const list = this._lastFilteredList && this._lastFilteredList.length ? this._lastFilteredList : this.data.contracts;
                if(!list || list.length === 0){ Swal.fire({ icon: 'info', title: 'ไม่มีข้อมูลเพื่อส่งออก' }); return; }
                if(window.XLSX){
                    const headers = ['id','name','phone','date','status','total','paid','installments','cost','resale','planType'];
                    const sheetData = list.map(r => {
                        const row = {};
                        headers.forEach(h => row[h] = r[h] === undefined || r[h] === null ? '' : r[h]);
                        return row;
                    });
                    const wb = XLSX.utils.book_new();
                    const ws = XLSX.utils.json_to_sheet(sheetData);
                    XLSX.utils.book_append_sheet(wb, ws, 'Contracts');
                    const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                    const blob = new Blob([wbout], { type: 'application/octet-stream' });
                    this._downloadBlob('contracts_export.xlsx', blob);
                } else {
                    // fallback to CSV
                    this.exportFilteredCSV();
                }
            },

            downloadTemplate: async function(e){
                // Prevent default navigation and attempt to fetch the template and trigger a blob download.
                try{
                    if(e && e.preventDefault) e.preventDefault();
                    const el = e && e.currentTarget ? e.currentTarget : null;
                    const url = el ? el.getAttribute('href') : 'csv/template-contracts.csv';
                    const resp = await fetch(url, { cache: 'no-store' });
                    if(!resp.ok) throw new Error('Network response was not ok');
                    const blob = await resp.blob();
                    const filename = (url.split('/').pop()) || 'template-contracts.csv';
                    this._downloadBlob(filename, blob);
                } catch(err){
                    // graceful fallback: navigate to the URL so browser handles it (or user can long-press to save on iOS)
                    try{ window.location = (e && e.currentTarget && e.currentTarget.getAttribute('href')) || 'csv/template-contracts.csv'; }catch(e){}
                }
            },

            // Generate installment schedule (must be defined before loadMockData)
            _generateInstallmentSchedule: function(startDate, installments, monthlyPayment, paidCount = 0) {
                const schedule = [];
                const start = new Date(startDate);
                
                for (let i = 0; i < installments; i++) {
                    const dueDate = new Date(start);
                    dueDate.setMonth(dueDate.getMonth() + i);
                    
                    let paidDate = null;
                    if (i < paidCount) {
                        paidDate = new Date(dueDate);
                        paidDate.setDate(dueDate.getDate() - Math.floor(Math.random() * 5));
                    }
                    
                    schedule.push({
                        period: i + 1,
                        dueDate: dueDate.toISOString().slice(0, 10),
                        amount: monthlyPayment,
                        paidDate: paidDate ? paidDate.toISOString().slice(0, 10) : null,
                        status: paidDate ? 'paid' : (new Date() > dueDate ? 'overdue' : 'pending')
                    });
                }
                
                return schedule;
            },

            loadMockData: function() {
                const currentCount = this.data.contracts.length;
                Swal.fire({
                    title: 'Load Mock Data?',
                    html: `This will add 5 sample contracts for testing.<br><br>Current contracts: <strong>${currentCount}</strong><br>After loading: <strong>${currentCount + 5}</strong>`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, load it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const today = new Date();
                        const mockContracts = [
                            { 
                                id: 'C-3001', 
                                name: 'ทดสอบ ระบบ', 
                                phone: '081-111-1111',
                                phoneRef: '081-111-1112',
                                nationalId: '1234567890123', 
                                address: '123 ถนนทดสอบ เขตบางกะปิ กรุงเทพฯ 10240',
                                addressWork: '456 อาคารสำนักงาน ถนนสุขุมวิท เขตคลองเตย กรุงเทพฯ',
                                addressIdCard: '789 หมู่ 3 ต.บางกะปิ อ.ห้วยขวาง จ.กรุงเทพฯ 10240',
                                date: '2024-03-01', 
                                status: 'Active', 
                                total: 45000, 
                                paid: 25000, 
                                before: 5000, 
                                installments: 12,
                                monthlyPayment: 3750,
                                firstInstallmentDate: '2024-04-01',
                                assetModel: 'iPhone 15 Pro',
                                assetCapacity: '256GB',
                                assetIMEI: '123456789012345',
                                assetCost: 25000,
                                downPayment: 5000,
                                payments: [], 
                                installmentSchedule: this._generateInstallmentSchedule('2024-04-01', 12, 3750, 5),
                                fee_paid: true, 
                                cost: 25000, 
                                resale: 0, 
                                timeline: [],
                                createdAt: new Date('2024-03-01').toISOString()
                            },
                            { 
                                id: 'C-3002', 
                                name: 'ตัวอย่าง ข้อมูล', 
                                phone: '082-222-2222',
                                phoneRef: '082-222-2223',
                                nationalId: '9876543210987', 
                                address: '456 ถนนสมมติ เขตดินแดง กรุงเทพฯ 10400',
                                addressWork: '789 อาคารทดสอบ ถนนรัชดา เขตดินแดง กรุงเทพฯ',
                                addressIdCard: '456 หมู่ 5 ต.ดินแดง อ.ดินแดง จ.กรุงเทพฯ 10400',
                                date: '2024-04-15', 
                                status: 'Approved', 
                                total: 60000, 
                                paid: 0, 
                                before: 10000, 
                                installments: 18,
                                monthlyPayment: 3333,
                                firstInstallmentDate: '2024-05-15',
                                assetModel: 'iPhone 15 Pro Max',
                                assetCapacity: '512GB',
                                assetIMEI: '987654321098765',
                                assetCost: 35000,
                                downPayment: 10000,
                                payments: [], 
                                installmentSchedule: this._generateInstallmentSchedule('2024-05-15', 18, 3333, 0),
                                fee_paid: false, 
                                cost: 35000, 
                                resale: 0, 
                                timeline: [],
                                createdAt: new Date('2024-04-15').toISOString()
                            },
                            { 
                                id: 'C-3003', 
                                name: 'ตัวอย่าง สอง', 
                                phone: '083-333-3333',
                                phoneRef: '083-333-3334',
                                nationalId: '1111222233334', 
                                address: '789 ถนนจำลอง เขตห้วยขวาง กรุงเทพฯ 10310',
                                addressWork: '123 อาคารตัวอย่าง ถนนพระราม 9 เขตห้วยขวาง กรุงเทพฯ',
                                addressIdCard: '789 หมู่ 8 ต.ห้วยขวาง อ.ห้วยขวาง จ.กรุงเทพฯ 10310',
                                date: '2023-12-01', 
                                status: 'Closed', 
                                total: 30000, 
                                paid: 30000, 
                                before: 3000, 
                                installments: 10,
                                monthlyPayment: 3000,
                                firstInstallmentDate: '2024-01-01',
                                assetModel: 'iPhone 14',
                                assetCapacity: '128GB',
                                assetIMEI: '111222333444555',
                                assetCost: 18000,
                                downPayment: 3000,
                                payments: [], 
                                installmentSchedule: this._generateInstallmentSchedule('2024-01-01', 10, 3000, 10),
                                fee_paid: true, 
                                cost: 18000, 
                                resale: 0, 
                                timeline: [],
                                createdAt: new Date('2023-12-01').toISOString()
                            },
                            { 
                                id: 'C-3004', 
                                name: 'ทดสอบ ค้างชำระ', 
                                phone: '084-444-4444',
                                phoneRef: '084-444-4445',
                                nationalId: '5555666677778', 
                                address: '321 ถนนตัวอย่าง เขตลาดพร้าว กรุงเทพฯ 10230',
                                addressWork: '654 อาคารสมมติ ถนนพหลโยธิน เขตจตุจักร กรุงเทพฯ',
                                addressIdCard: '321 หมู่ 12 ต.ลาดพร้าว อ.ลาดพร้าว จ.กรุงเทพฯ 10230',
                                date: '2023-06-01', 
                                status: 'Active', 
                                total: 50000, 
                                paid: 10000, 
                                before: 5000, 
                                installments: 15,
                                monthlyPayment: 3333,
                                firstInstallmentDate: '2023-07-01',
                                assetModel: 'Samsung Galaxy S23 Ultra',
                                assetCapacity: '256GB',
                                assetIMEI: '555666777888999',
                                assetCost: 28000,
                                downPayment: 5000,
                                payments: [], 
                                installmentSchedule: this._generateInstallmentSchedule('2023-07-01', 15, 3333, 3),
                                fee_paid: false, 
                                cost: 28000, 
                                resale: 0, 
                                timeline: [],
                                createdAt: new Date('2023-06-01').toISOString()
                            },
                            { 
                                id: 'C-3005', 
                                name: 'ลูกค้า ยกเลิก', 
                                phone: '085-555-5555',
                                phoneRef: '085-555-5556',
                                nationalId: '9999888877776', 
                                address: '654 ถนนจำลอง เขตสะพานควาย กรุงเทพฯ 10510',
                                addressWork: '987 อาคารทดลอง ถนนพญาไท เขตราชเทวี กรุงเทพฯ',
                                addressIdCard: '654 หมู่ 15 ต.สะพานควาย อ.สะพานควาย จ.กรุงเทพฯ 10510',
                                date: '2024-02-01', 
                                status: 'Cancelled', 
                                total: 40000, 
                                paid: 5000, 
                                before: 0, 
                                installments: 12,
                                monthlyPayment: 3333,
                                firstInstallmentDate: '2024-03-01',
                                assetModel: 'iPhone 14 Pro',
                                assetCapacity: '256GB',
                                assetIMEI: '999888777666555',
                                assetCost: 22000,
                                downPayment: 0,
                                payments: [], 
                                installmentSchedule: this._generateInstallmentSchedule('2024-03-01', 12, 3333, 2),
                                fee_paid: false, 
                                cost: 22000, 
                                resale: 18000, 
                                timeline: [],
                                createdAt: new Date('2024-02-01').toISOString()
                            }
                        ];
                        
                        // Remove existing mock data (C-3001 to C-3005) before re-loading
                        console.log('=== LOAD MOCK DATA DEBUG ===');
                        console.log('Before cleanup:', this.data.contracts.length);
                        const mockIds = mockContracts.map(m => m.id);
                        this.data.contracts = this.data.contracts.filter(c => !mockIds.includes(c.id));
                        console.log('After removing old mock data:', this.data.contracts.length);
                        
                        // Add fresh mock data
                        mockContracts.forEach(mock => {
                            this.data.contracts.push(mock);
                            console.log(`✓ Added ${mock.id}`);
                        });
                        
                        console.log('After adding mock data:', this.data.contracts.length);
                        console.log('All contracts:', this.data.contracts);
                        
                        // Clear all filters to show all data
                        $('#filter-status').val('all');
                        $('#filter-finance').val('all');
                        $('#search-text').val('');
                        $('#list-start').val('');
                        $('#list-end').val('');
                        
                        this.saveData();
                        this.renderTable();
                        this.renderCustomers();
                        this.renderDashboard();
                        
                        console.log('✓ Filters cleared and table re-rendered');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Mock Data Loaded!',
                            html: `Added <strong>${added}</strong> new contracts<br>Total: <strong>${this.data.contracts.length}</strong> contracts`,
                            timer: 2500,
                            showConfirmButton: false
                        });
                    }
                });
            },

            renderTable: function() {
                const tbody = $('#table-body');
                const fStat = $('#filter-status').val();
                const fFin = $('#filter-finance').val();
                const q = ($('#search-text').val() || '').toLowerCase().trim();
                const s = $('#list-start').val();
                const e = $('#list-end').val();
                tbody.empty();

                const filtered = [];

                // helper to compute overdue period in Y M D
                const overduePeriod = (dateStr, status) => {
                    if(!dateStr || status !== 'Active') return { text: 'ปกติ', isOverdue: false };
                    const start = new Date(dateStr);
                    const now = new Date();
                    let diff = Math.floor((now - start) / (1000*60*60*24));
                    if(diff <= 30) return { text: `${diff} วัน`, isOverdue: false, days: diff };
                    const years = Math.floor(diff / 365);
                    diff = diff % 365;
                    const months = Math.floor(diff / 30);
                    const days = diff % 30;
                    let parts = [];
                    if(years) parts.push(`${years} ปี`);
                    if(months) parts.push(`${months} เดือน`);
                    if(days) parts.push(`${days} วัน`);
                    return { text: `${parts.join(' ')}`, isOverdue: true, days: (years*365 + months*30 + days) };
                };

                this.data.contracts.forEach(c => {
                    // date range filter for list
                    if((s || e) && c.date){
                        const dt = new Date(c.date);
                        if(s){ const st = new Date(s); if(dt < st) return; }
                        if(e){ const en = new Date(e); if(dt > en) return; }
                    }
                    // search filter
                    if(q){
                        const hay = `${c.id} ${c.name} ${c.phone}`.toLowerCase();
                        if(hay.indexOf(q) === -1) return;
                    }

                    const ov = overduePeriod(c.date, c.status);
                    if(fStat !== 'all' && c.status !== fStat) return;
                    if(fFin === 'Overdue' && !ov.isOverdue) return;
                    if(fFin === 'Paid' && ov.isOverdue) return;

                    // determine payment type
                    let ptype = c.planType || c.type || '';
                    if(!ptype){
                        if(c.status === 'Asset Return') ptype = 'คืนสินทรัพย์';
                        else if((c.installments||0) > 1) ptype = 'ผ่อนชำระ';
                        else ptype = 'ผ่อนขั้นต่ำ';
                    }

                    filtered.push(c);

                    let badge = `<span class="badge bg-gray-100 text-gray-500 px-2 py-1 rounded text-xs font-bold">${c.status}</span>`;
                    if(c.status === 'Active') badge = `<span class="badge bg-green-100 text-green-700 px-2 py-1 rounded text-xs font-bold">Active</span>`;
                    if(c.status === 'Approved') badge = `<span class="badge bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">Approved</span>`;
                    if(c.status === 'Asset Return') badge = `<span class="badge bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs font-bold">Return</span>`;
                    if(c.status === 'Closed') badge = `<span class="badge bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs font-bold">Closed</span>`;
                    if(c.status === 'Cancelled') badge = `<span class="badge bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold">Cancelled</span>`;

                    let finText = `<span class="text-green-600 font-bold text-xs">ปกติ</span>`;
                    if(ov.isOverdue) finText = `<span class="text-red-500 font-bold text-xs"><i class="fas fa-clock mr-1"></i>ค้าง ${ov.text}</span>`;

                    const total = c.total || 0;
                    const paid = c.paid || 0;
                    const remaining = total - paid;

                    tbody.append(`
                        <tr class="hover:bg-blue-50/50 transition cursor-pointer" onclick="app.openDetail('${c.id}')">
                            <td class="px-6 py-4">${badge}</td>
                            <td class="px-6 py-4 font-mono">
                                <a href="#" onclick="event.stopPropagation(); app.openDetail('${c.id}'); return false;" class="text-blue-600 font-bold hover:underline">
                                    ${c.id}
                                </a>
                            </td>
                            <td class="px-6 py-4 font-medium text-gray-900">${c.name}</td>
                            <td class="px-6 py-4 text-sm text-gray-600 font-mono">${c.phone || '-'}</td>
                            <td class="px-6 py-4 text-gray-500 text-xs font-mono">${c.date}</td>
                            <td class="px-6 py-4 text-right font-mono text-gray-700">${total.toLocaleString()} ฿</td>
                            <td class="px-6 py-4 text-right font-mono text-green-600 font-bold">${paid.toLocaleString()} ฿</td>
                            <td class="px-6 py-4">${finText}</td>
                            <td class="px-6 py-4 text-right font-mono font-bold ${remaining > 0 ? 'text-red-600' : 'text-green-600'}">${remaining.toLocaleString()} ฿</td>
                            <td class="px-6 py-4 text-center">
                                <button onclick="event.stopPropagation(); app.openDetail('${c.id}')" class="btn-secondary px-3 py-1 text-xs" title="ดูรายละเอียด">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });

                this._lastFilteredList = filtered;

                if(this.data.contracts.length === 0){
                    tbody.html('<tr><td colspan="10" class="text-center py-8 text-sm text-gray-400"><i class="fas fa-inbox text-3xl mb-2 block"></i>ไม่มีสัญญา — กรุณา Import CSV หรือคลิก "Load Mock Data" เพื่อโหลดข้อมูลตัวอย่าง</td></tr>');
                } else if(filtered.length === 0){
                    tbody.html('<tr><td colspan="10" class="text-center py-8 text-sm text-gray-400"><i class="fas fa-search text-3xl mb-2 block"></i>ไม่พบสัญญาที่ตรงกับเงื่อนไขการค้นหา</td></tr>');
                }
            },

            importCSV: function(e){
                const file = e.target.files && e.target.files[0];
                if(!file) return;
                const self = this;
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results){
                        if(!results || !results.data || results.data.length === 0){
                            Swal.fire({ icon: 'error', title: 'ไฟล์ว่าง หรือ แปลงค่าไม่ได้' });
                            return;
                        }
                        // store parsed rows for confirmation
                        self._csvBuffer = results.data.map(r => {
                            return {
                                id: (r.id || r.ID || '').trim(),
                                name: (r.name || r.Name || r.customer || '').trim(),
                                phone: (r.phone || r.Phone || '').trim(),
                                date: (r.date || r.Date || new Date().toISOString().slice(0,10)).trim(),
                                status: (r.status || 'Active').trim(),
                                total: Number(r.total || r.Total || 0),
                                paid: Number(r.paid || r.Paid || 0),
                                installments: Number(r.installments || 1),
                                cost: Number(r.cost || 0),
                                resale: Number(r.resale || 0),
                                planType: (r.type || r.planType || r.plan || '').trim()
                            };
                        });
                        // show preview
                        self.showCSVPreview();
                    },
                    error: function(err){
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาดในการอ่าน CSV', text: err.message || err });
                    }
                });
                // clear input selection to allow re-upload of same file
                $('#csv-input').val('');
            },

            showCSVPreview: function(){
                const buf = this._csvBuffer || [];
                const wrap = $('#csv-preview-table');
                wrap.empty();
                if(buf.length === 0){ wrap.html('<div class="text-xs text-gray-500">ไม่มีข้อมูลสำหรับ preview</div>'); $('#csv-preview').removeClass('hidden'); return; }
                const table = $('<table class="w-full text-left text-xs"></table>');
                const thead = $('<thead class="bg-gray-50 text-gray-500 uppercase text-[10px] font-bold"></thead>');
                const headers = Object.keys(buf[0]);
                const trh = $('<tr></tr>'); headers.forEach(h => trh.append(`<th class="px-3 py-2">${h}</th>`)); thead.append(trh);
                const tbody = $('<tbody></tbody>');

                buf.slice(0,50).forEach(row => {
                    const tr = $('<tr></tr>'); headers.forEach(h => tr.append(`<td class="px-3 py-1 align-top">${(row[h]===undefined)?'':row[h]}</td>`)); tbody.append(tr);
                });
                table.append(thead).append(tbody);
                wrap.append(table);
                $('#csv-preview').removeClass('hidden');
            },

            confirmImport: function(){
                const buf = this._csvBuffer || [];
                if(buf.length === 0) { Swal.fire({ icon: 'error', title: 'ไม่มีข้อมูลที่จะแนบ' }); return; }
                // basic validation: require name and id
                const valid = buf.filter(r => r.name && r.id).length;
                if(valid !== buf.length){
                    if(!confirm(`พบ ${buf.length-valid} แถวที่ไม่มี id หรือ name — นำเข้าข้อมูลที่ถูกต้องเท่านั้น?`)) return;
                }
                buf.forEach(r => {
                    const contract = {
                        id: r.id || ('C-'+Math.floor(Math.random()*9000+1000)),
                        name: r.name || 'Unknown',
                        phone: r.phone || '',
                        date: r.date || new Date().toISOString().slice(0,10),
                        status: r.status || 'Active',
                        total: Number(r.total || 0),
                        paid: Number(r.paid || 0),
                        before: 0,
                        installments: Number(r.installments || 1),
                        payments: [],
                        cost: Number(r.cost || 0),
                        resale: Number(r.resale || 0),
                        planType: r.planType || r.type || ''
                    };
                    this.data.contracts.push(contract);
                });
                this.saveData();
                this.renderTable();
                this.renderCustomers();
                $('#csv-preview').addClass('hidden');
                this._csvBuffer = null;
                Swal.fire({ icon: 'success', title: 'Import สำเร็จ', text: `${buf.length} รายการถูกนำเข้า` });
            },

            openDetail: function(id) {
                this.data.currentId = id;
                const c = this.data.contracts.find(x => x.id === id);
                if(!c) { Swal.fire({ icon: 'error', title: 'ไม่พบสัญญา', text: `ไม่พบสัญญา id=${id}` }); return; }

                $('#view-list').addClass('hidden');
                $('#view-detail').removeClass('hidden');
                $('#page-title').text('Workstation');

                // Customer Information
                $('#det-name').text(c.name || '-');
                $('#det-id').text(id || '-');
                $('#det-national-id').text(c.nationalId || '-');
                $('#det-phone').text(c.phone || '-');
                $('#det-phone-ref').text(c.phoneRef || '-');
                $('#det-date').text(c.date || '-');
                $('#det-address').text(c.address || '-');
                $('#det-address-work').text(c.addressWork || '-');
                $('#det-address-idcard').text(c.addressIdCard || '-');
                
                // Asset Information
                $('#det-asset-model').text(c.assetModel || '-');
                $('#det-asset-capacity').text(c.assetCapacity || '-');
                $('#det-asset-imei').text(c.assetIMEI || '-');
                $('#det-asset-cost').text(c.assetCost ? c.assetCost.toLocaleString() + ' ฿' : '-');
                $('#det-down-payment').text(c.downPayment ? c.downPayment.toLocaleString() + ' ฿' : '-');
                $('#det-monthly-payment').text(c.monthlyPayment ? c.monthlyPayment.toLocaleString() + ' ฿' : '-');
                $('#det-first-installment').text(c.firstInstallmentDate || '-');
                $('#det-installments').text(c.installments ? c.installments + ' งวด' : '-');
                
                // Payment Summary
                const total = c.total || 0;
                const paid = c.paid || 0;
                const balance = total - paid;
                $('#det-total').text(total.toLocaleString() + ' ฿');
                $('#det-paid').text(paid.toLocaleString() + ' ฿');
                $('#det-balance').text(balance.toLocaleString() + ' ฿');
                $('#det-status').text(c.status || '-');
                $('#det-cost').text((c.cost || 0).toLocaleString());
                
                // Payment Progress Bar
                try{
                    const pct = total > 0 ? Math.min(100, Math.round((paid/total)*100)) : 0;
                    $('#payment-progress-bar').css('width', pct + '%').text(pct + '%');
                    $('#payment-percent').text(pct + '%');
                }catch(e){ }
                
                // Installment Schedule Table
                const scheduleBody = $('#installment-schedule-body');
                scheduleBody.empty();
                if(Array.isArray(c.installmentSchedule) && c.installmentSchedule.length > 0) {
                    c.installmentSchedule.forEach(inst => {
                        const statusBadge = inst.status === 'paid' ? 
                            '<span class="badge bg-green-100 text-green-700 px-2 py-1 rounded text-xs">ชำระแล้ว</span>' :
                            '<span class="badge bg-orange-100 text-orange-700 px-2 py-1 rounded text-xs">ยังไม่ชำระ</span>';
                        scheduleBody.append(`
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3">${inst.period}</td>
                                <td class="px-4 py-3">${inst.dueDate}</td>
                                <td class="px-4 py-3 text-right font-bold">${inst.amount.toLocaleString()} ฿</td>
                                <td class="px-4 py-3">${inst.paidDate || '-'}</td>
                                <td class="px-4 py-3 text-center">${statusBadge}</td>
                            </tr>
                        `);
                    });
                } else {
                    scheduleBody.html('<tr><td colspan="5" class="px-4 py-8 text-center text-gray-400">ไม่มีข้อมูลตารางผ่อน</td></tr>');
                }
                
                // Call Logs
                this.renderCallLogs(c);
                // Call Logs
                this.renderCallLogs(c);
                
                // Attachments
                const att = $('#attachments');
                att.empty();
                    if(Array.isArray(c.attachments) && c.attachments.length>0){
                    const wrap = $('<div class="grid grid-cols-2 gap-2"></div>');
                    c.attachments.forEach(a=>{
                        const ext = (a.name.split('.').pop()||'').toLowerCase();
                        let node = '';
                        if(a.url && ['jpg','jpeg','png','gif'].includes(ext)){
                            node = `<a href="#" onclick="app.openAttachment('${a.url}','image','${a.name}');return false"><img src="${a.url}" class="w-full h-28 object-cover rounded" alt="${a.name}"></a><div class="text-xs text-gray-500 mt-1">${a.name}</div>`;
                        } else if(a.url && ext === 'pdf'){
                            node = `<div class="p-3 bg-gray-50 rounded text-xs"><a href="#" onclick="app.openAttachment('${a.url}','pdf','${a.name}');return false" class="text-blue-600 hover:underline"><i class=\"fas fa-file-pdf mr-2 text-red-500\"></i>${a.name}</a></div>`;
                        } else if(a.url && ['mp3','wav','m4a'].includes(ext)){
                            node = `<div class="p-3 bg-gray-50 rounded text-xs"><a href="#" onclick="app.openAttachment('${a.url}','audio','${a.name}');return false" class="text-blue-600 hover:underline"><i class=\"fas fa-file-audio mr-2\"></i>${a.name}</a></div>`;
                        } else if(a.url){
                            node = `<div class="p-3 bg-gray-50 rounded text-xs"><a href="${a.url}" target="_blank" class="text-blue-600 hover:underline">${a.name}</a></div>`;
                        } else {
                            node = `<div class="p-3 bg-gray-50 rounded text-xs">${a.name}</div>`;
                        }
                        wrap.append(`<div>${node}</div>`);
                    });
                    att.append(wrap);
                    att.append('<div class="mt-2"><label class="btn-secondary inline-block px-3 py-2 cursor-pointer">แนบเพิ่ม<input type="file" class="hidden attach-file-input" onchange="app.addAttachment(event)"></label></div>');
                } else {
                    att.html('<p class="text-xs text-gray-400">ยังไม่มีไฟล์แนบ</p><div class="mt-2"><label class="btn-secondary inline-block px-3 py-2 cursor-pointer">แนบไฟล์<input type="file" class="hidden attach-file-input" onchange="app.addAttachment(event)"></label></div>');
                }

                if(c.status === 'Approved') $('#action-approve').removeClass('hidden');
                else $('#action-approve').addClass('hidden');

                // render payment history into mini-history table
                const mh = $('#mini-history');
                mh.find('tbody').empty();
                if(Array.isArray(c.payments) && c.payments.length > 0) {
                    c.payments.forEach(p => {
                        mh.find('tbody').append(`<tr><td class="px-2 py-1 text-xs text-gray-500">${p.date}</td><td class="px-2 py-1 text-xs">${p.type}</td><td class="px-2 py-1 text-xs text-right font-bold">${Number(p.amount).toLocaleString()}</td><td class="px-2 py-1 text-xs text-blue-600">${p.receipt || '-'}</td></tr>`);
                    });
                } else {
                    mh.find('tbody').html('<tr><td colspan="4" class="text-center py-4 text-xs text-gray-400">ไม่มีประวัติ</td></tr>');
                }

                // update payment progress bar
                try{
                    const total = Number(c.total || 0);
                    const paid = Number(c.paid || 0);
                    const pct = total > 0 ? Math.min(100, Math.round((paid/total)*100)) : 0;
                    $('#payment-progress-bar').css('width', pct + '%');
                    $('#payment-percent').text(pct + '% (ชำระแล้ว ' + paid.toLocaleString() + ' / ' + total.toLocaleString() + ')');
                }catch(e){ }

                this.renderTimeline(c);
            },

            renderCallLogs: function(c) {
                const logsList = $('#call-logs-list');
                logsList.empty();
                
                if(!c.callLogs) c.callLogs = [];
                
                if(c.callLogs.length === 0) {
                    logsList.html('<p class="text-gray-400 text-center py-8">ยังไม่มีบันทึกการโทร</p>');
                    return;
                }
                
                c.callLogs.forEach((log, idx) => {
                    const statusClass = log.result === 'success' ? 'bg-green-50 border-green-200' : 
                                       log.result === 'no-answer' ? 'bg-yellow-50 border-yellow-200' :
                                       'bg-red-50 border-red-200';
                    const statusIcon = log.result === 'success' ? 'fa-check-circle text-green-600' : 
                                      log.result === 'no-answer' ? 'fa-phone-slash text-yellow-600' :
                                      'fa-times-circle text-red-600';
                    
                    logsList.append(`
                        <div class="${statusClass} border p-4 rounded-lg">
                            <div class="flex justify-between items-start mb-2">
                                <div class="flex items-center gap-2">
                                    <i class="fas ${statusIcon}"></i>
                                    <span class="font-bold text-sm">${log.date} ${log.time}</span>
                                </div>
                                <button onclick="app.deleteCallLog(${idx})" class="text-red-500 hover:text-red-700 text-xs">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <p class="text-sm text-gray-700 mb-1"><strong>ผล:</strong> ${log.result === 'success' ? 'ติดต่อได้' : log.result === 'no-answer' ? 'ไม่รับสาย' : 'ไม่สำเร็จ'}</p>
                            <p class="text-sm text-gray-600">${log.notes || 'ไม่มีบันทึก'}</p>
                            ${log.nextFollowUp ? `<p class="text-xs text-blue-600 mt-2"><i class="fas fa-calendar mr-1"></i>ติดตามครั้งถัดไป: ${log.nextFollowUp}</p>` : ''}
                        </div>
                    `);
                });
            },
            
            addCallLog: function() {
                const c = this.data.contracts.find(x => x.id === this.data.currentId);
                if(!c) return;
                
                const self = this;
                Swal.fire({
                    title: 'บันทึกการโทร',
                    html: `
                        <div class="space-y-4 text-left">
                            <div>
                                <label class="text-xs font-bold text-gray-600 block mb-1">ผลการติดต่อ</label>
                                <select id="call-result" class="apple-input w-full">
                                    <option value="success">ติดต่อได้</option>
                                    <option value="no-answer">ไม่รับสาย</option>
                                    <option value="failed">ไม่สำเร็จ</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-600 block mb-1">บันทึก</label>
                                <textarea id="call-notes" class="apple-input w-full" rows="3" placeholder="รายละเอียดการสนทนา..."></textarea>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-600 block mb-1">นัดติดตามครั้งถัดไป (ถ้าต้องการ)</label>
                                <input type="date" id="call-next-followup" class="apple-input w-full">
                            </div>
                        </div>
                    `,
                    width: '500px',
                    showCancelButton: true,
                    confirmButtonText: 'บันทึก',
                    cancelButtonText: 'ยกเลิก',
                    preConfirm: () => {
                        const result = $('#call-result').val();
                        const notes = $('#call-notes').val();
                        const nextFollowUp = $('#call-next-followup').val();
                        
                        if(!notes.trim()) {
                            Swal.showValidationMessage('กรุณาบันทึกรายละเอียด');
                            return false;
                        }
                        
                        return { result, notes, nextFollowUp };
                    }
                }).then(result => {
                    if(result.isConfirmed) {
                        if(!c.callLogs) c.callLogs = [];
                        
                        const now = new Date();
                        const callLog = {
                            date: now.toLocaleDateString('th-TH'),
                            time: now.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' }),
                            result: result.value.result,
                            notes: result.value.notes,
                            nextFollowUp: result.value.nextFollowUp,
                            by: (self.currentUser && self.currentUser.username) || 'system'
                        };
                        
                        c.callLogs.unshift(callLog);
                        
                        // Add to timeline
                        if(!c.timeline) c.timeline = [];
                        c.timeline.unshift({ 
                            time: now.toLocaleDateString('th-TH'), 
                            text: `📞 โทรติดตามลูกค้า: ${result.value.notes.substring(0, 50)}${result.value.notes.length > 50 ? '...' : ''}` 
                        });
                        
                        self.saveData();
                        self.openDetail(self.data.currentId);
                        Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', timer: 1500, showConfirmButton: false });
                    }
                });
            },
            
            deleteCallLog: function(idx) {
                const c = this.data.contracts.find(x => x.id === this.data.currentId);
                if(!c || !c.callLogs) return;
                
                const self = this;
                Swal.fire({
                    title: 'ลบบันทึกนี้?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ลบ',
                    cancelButtonText: 'ยกเลิก'
                }).then(result => {
                    if(result.isConfirmed) {
                        c.callLogs.splice(idx, 1);
                        self.saveData();
                        self.openDetail(self.data.currentId);
                        Swal.fire({ icon: 'success', title: 'ลบสำเร็จ', timer: 1500, showConfirmButton: false });
                    }
                });
            },

            renderAssets: function(type) {
                const tbody = $('#table-assets');
                tbody.empty();
                let list = [];

                if(!type) type = $('#asset-filter').val() || 'assets-leased';
                if(type === 'assets-leased') {
                    $('#asset-title').text('สินทรัพย์ในระบบ (Leased)');
                    list = this.data.assets.filter(a => a.status === 'leased');
                } else {
                    $('#asset-title').text('สต็อกสินค้า (Stock)');
                    list = this.data.assets.filter(a => a.status === 'stock');
                }
                $('#asset-count').text(list.length + ' รายการ');

                list.forEach(a => {
                    tbody.append(`
                        <tr class="hover:bg-white transition border-b border-gray-100" data-asset="${a.assetId}">
                            <td class="px-6 py-4 font-mono text-gray-500">${a.assetId}</td>
                            <td class="px-6 py-4 font-bold text-gray-800">${a.model || 'Unknown'}</td>
                            <td class="px-6 py-4 text-xs">${a.status === 'stock' ? '<span class="text-orange-500 font-bold">รอขาย</span>' : '<span class="text-blue-500">อยู่กับลูกค้า</span>'}</td>
                            <td class="px-6 py-4 text-right font-mono">${(a.cost||0).toLocaleString()}</td>
                            <td class="px-6 py-4 text-right font-mono font-bold text-green-600">${a.resale > 0 ? (a.resale||0).toLocaleString() : '-'}</td>
                        </tr>
                    `);
                });
                if(list.length === 0) tbody.html('<tr><td colspan="5" class="text-center py-6 text-xs text-gray-400">ไม่มีรายการ</td></tr>');
            },

            renderTimeline: function(c) {
                const feed = $('#timeline-feed');
                feed.empty();
                feed.append(`<div class="timeline-line"><div class="timeline-dot bg-gray-300 border-gray-100"></div><p class="text-xs text-gray-400">${c.date}</p><p class="text-sm font-bold text-gray-700">เริ่มสัญญา</p></div>`);
                if(c.timeline) {
                    c.timeline.forEach(t => {
                        let html = `<div class="timeline-line"><div class="timeline-dot"></div><p class="text-xs text-gray-400">${t.time}</p><p class="text-sm font-bold text-gray-800 bg-white p-3 rounded-xl border border-gray-100 shadow-sm mt-1">${t.text}`;
                        if(Array.isArray(t.attachments) && t.attachments.length>0){
                            html += '<div class="mt-2 space-y-2">';
                            t.attachments.forEach(a=>{
                                const ext = (a.name.split('.').pop()||'').toLowerCase();
                                let icon = '<i class="fas fa-file"></i>';
                                if(['jpg','jpeg','png','gif'].includes(ext)) icon = '<i class="fas fa-image"></i>';
                                if(['pdf'].includes(ext)) icon = '<i class="fas fa-file-pdf text-red-500"></i>';
                                if(['mp3','wav','m4a'].includes(ext)) icon = '<i class="fas fa-file-audio"></i>';
                                html += `<div class="flex items-center gap-2 text-xs text-gray-600">${icon} <span class="font-medium">${a.name}</span> <span class="text-gray-400">• ${a.time}</span></div>`;
                            });
                            html += '</div>';
                        }
                        html += '</p></div>';
                        feed.append(html);
                    });
                }
            },

            // Add attachment to current contract (client-side only)
            uploadFiles: async function(files){
                if(!files || files.length === 0) return [];
                // client-side validations
                const allowed = ['jpg','jpeg','png','gif','pdf','mp3','wav','m4a','txt'];
                const maxSize = 10 * 1024 * 1024; // 10 MB per file
                for(const f of files){
                    const ext = (f.name.split('.').pop()||'').toLowerCase();
                    if(allowed.indexOf(ext) === -1){ Swal.fire({ icon: 'error', title: 'ชนิดไฟล์ไม่รองรับ', text: `ไฟล์ ${f.name} ไม่รองรับ` }); return []; }
                    if(f.size > maxSize){ Swal.fire({ icon: 'error', title: 'ไฟล์ใหญ่เกินไป', text: `ไฟล์ ${f.name} เกิน ${Math.round(maxSize/1024/1024)}MB` }); return []; }
                }
                try{
                    const fd = new FormData();
                    files.forEach(f => fd.append('files', f));
                    // If a global upload token is provided (for protected servers), include it
                    const headers = {};
                    if(window && window.UPLOAD_TOKEN) headers['x-upload-token'] = window.UPLOAD_TOKEN;
                    const resp = await fetch('/upload', { method: 'POST', body: fd, headers });
                    if(!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(txt || 'Upload error');
                    }
                    const data = await resp.json();
                    if(!data || !data.files) throw new Error(data && data.error ? data.error : 'Upload failed');
                    return data.files;
                }catch(err){
                    console.warn('upload error', err);
                    Swal.fire({ icon: 'error', title: 'อัปโหลดไฟล์ล้มเหลว', text: err.message || err });
                    return [];
                }
            },

            addAttachment: async function(e){
                const files = e.target.files ? Array.from(e.target.files) : [];
                if(files.length === 0) return;
                const c = this.data.contracts.find(x=>x.id === this.data.currentId);
                if(!c) { Swal.fire({ icon: 'error', title: 'ไม่พบสัญญา' }); return; }
                if(!c.attachments) c.attachments = [];
                const uploaded = await this.uploadFiles(files);
                uploaded.forEach(u => c.attachments.push({ name: u.name, url: u.url, size: u.size, time: new Date().toLocaleString() }));
                this.saveData();
                this.openDetail(this.data.currentId);
                Swal.fire({ icon: 'success', title: 'เพิ่มไฟล์แนบแล้ว' });
            },

            skipTo: function(id){
                const el = document.getElementById(id);
                if(!el) return;
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // small highlight
                $(el).addClass('ring-4 ring-blue-200');
                setTimeout(()=> $(el).removeClass('ring-4 ring-blue-200'), 1400);
            },

            updateStatus: function(status){
                const self = this;
                const c = this.data.contracts.find(x => x.id === this.data.currentId);
                if(!c) { Swal.fire({ icon: 'error', title: 'ไม่พบสัญญา' }); return; }
                // Require admin approval (password) unless currentUser is Admin/Manager
                try{ this.currentUser = JSON.parse(localStorage.getItem('tms_user') || 'null'); }catch(e){ this.currentUser = null; }
                const isAdmin = this.currentUser && (this.currentUser.role === 'Admin' || this.currentUser.role === 'Manager');
                const proceedChange = (approver) => {
                    const oldStatus = c.status;
                    c.status = status;
                    if(!c.timeline) c.timeline = [];
                    
                    if(status === 'Asset Return'){
                        c.timeline.unshift({ time: new Date().toLocaleDateString('th-TH'), text: '🔁 คืนสินทรัพย์ → ย้ายไป STOCK' });
                        
                        // Create or update asset in STOCK
                        const assetId = (c.id || 'C-') + '-AST';
                        let asset = self.data.assets.find(a => a.assetId === assetId);
                        
                        if(!asset){
                            // Create new asset
                            asset = { 
                                assetId: assetId, 
                                contractId: c.id, 
                                model: c.assetModel || c.model || 'Unknown Model', 
                                status: 'stock', 
                                cost: c.assetCost || c.cost || 0, 
                                resale: c.resale || Math.round((c.assetCost || c.cost || 0) * 0.7), 
                                returnedAt: new Date().toLocaleString(),
                                capacity: c.assetCapacity || '',
                                imei: c.assetIMEI || ''
                            };
                            self.data.assets.push(asset);
                            console.log('✓ Created new asset in STOCK:', assetId);
                        } else {
                            // Update existing asset to stock
                            asset.status = 'stock';
                            asset.returnedAt = new Date().toLocaleString();
                            asset.model = c.assetModel || asset.model;
                            asset.capacity = c.assetCapacity || asset.capacity;
                            asset.imei = c.assetIMEI || asset.imei;
                            console.log('✓ Updated asset to STOCK:', assetId);
                        }
                        
                        c._assetAddedId = assetId;
                        
                        Swal.fire({ 
                            icon: 'success', 
                            title: 'คืนสินทรัพย์สำเร็จ', 
                            html: `สินทรัพย์ <strong>${asset.model}</strong><br>ถูกย้ายไป STOCK แล้ว<br><small>รหัส: ${assetId}</small>`,
                            timer: 3000
                        });
                        
                    } else if(status === 'Closed'){
                        c.timeline.unshift({ time: new Date().toLocaleDateString('th-TH'), text: '🔒 ปิดบัญชี' });
                    } else if(status === 'Cancelled'){
                        c.timeline.unshift({ time: new Date().toLocaleDateString('th-TH'), text: '❌ ยกเลิกสัญญา' });
                    } else {
                        c.timeline.unshift({ time: new Date().toLocaleDateString('th-TH'), text: `🔁 เปลี่ยนสถานะเป็น ${status}` });
                    }
                    // record status change to centralized log
                    try{
                        const logKey = 'status_change_log_v1';
                        const entry = { time: new Date().toISOString(), contractId: c.id, from: oldStatus, to: status, by: approver || (this.currentUser && this.currentUser.username) || 'unknown' };
                        const logsRaw = localStorage.getItem(logKey) || '[]';
                        const logs = JSON.parse(logsRaw || '[]');
                        logs.unshift(entry);
                        localStorage.setItem(logKey, JSON.stringify(logs.slice(0,500)));
                    }catch(e){}

                    self.saveData();
                    self.renderDashboard();
                    self.renderTable();
                    self.renderAssets();
                    self.renderCustomers();
                    self.openDetail(self.data.currentId);
                    Swal.fire({ title: 'เปลี่ยนสถานะเรียบร้อย', text: `สถานะปัจจุบัน: ${status}`, icon: 'success' });
                };

                if(isAdmin){
                    // admin can change directly
                    if(!confirm(`Admin: ยืนยันเปลี่ยนสถานะ ${c.id} → ${status}?`)) return;
                    proceedChange(this.currentUser && this.currentUser.username);
                    return;
                }

                // non-admin: require admin password confirmation (modal exists for approve uses #approve-pass)
                $('#approve-pass').val('');
                $('#modal-approve').removeClass('hidden').addClass('flex');
                const handler = () => {
                    const pass = $('#approve-pass').val();
                    if(pass === '1234'){
                        $('#modal-approve').addClass('hidden').removeClass('flex');
                        proceedChange('admin-password');
                    } else {
                        Swal.fire({ icon: 'error', title: 'รหัสผ่านผิด หรือ ต้องเป็น Admin' });
                    }
                };
                // Replace confirm/cancel handlers inside modal temporarily
                $('#modal-approve').find('button').off('click');
                $('#modal-approve').find('button:contains("ยืนยัน")').off('click').on('click', handler);
                $('#modal-approve').find('button:contains("ยกเลิก")').off('click').on('click', ()=>{ $('#modal-approve').addClass('hidden').removeClass('flex'); });
            },

            renderCustomers: function(query){
                const wrap = $('#customers-list');
                wrap.empty();
                query = (typeof query === 'string') ? query.toLowerCase().trim() : ($('#cust-search').val() || '').toLowerCase().trim();

                // build map keyed by name+phone to group contracts
                const map = {};
                this.data.contracts.forEach(c => {
                    if(!c.name) return;
                    const k = (c.name||'') + '|' + (c.phone||'');
                    map[k] = map[k] || { name: c.name||'', phone: c.phone||'', nationalId: c.nationalId || c.idCard || '', address: c.address || '', contracts: [] };
                    map[k].contracts.push(c);
                });

                const values = Object.values(map).sort((a,b)=> b.contracts.length - a.contracts.length);
                const filtered = values.filter(entry => {
                    if(!query) return true;
                    const hay = `${entry.name} ${entry.phone} ${entry.nationalId} ${entry.address} ${entry.contracts.map(x=>x.id).join(' ')}`.toLowerCase();
                    return hay.indexOf(query) !== -1;
                });

                if(filtered.length === 0){
                    wrap.html('<div class="p-4 bg-white rounded-xl border text-sm text-gray-400">ไม่พบลูกค้า</div>');
                    return;
                }

                // Add table header
                wrap.append(`
                    <div class="glass-panel p-3 mb-2 bg-gray-50 font-bold text-xs text-gray-600">
                        <div class="grid grid-cols-8 gap-3">
                            <div class="col-span-1">เลขสัญญา</div>
                            <div class="col-span-1">ชื่อ-สกุล</div>
                            <div class="col-span-1">กำหนดชำระ</div>
                            <div class="col-span-1 text-center">จำนวนวันค้าง</div>
                            <div class="col-span-1">สถานะชำระ</div>
                            <div class="col-span-3 text-right">การดำเนินการ</div>
                        </div>
                    </div>
                `);

                // load overrides for payment quality
                const overridesRaw = localStorage.getItem('payment_quality_overrides') || '{}';
                let overrides = {};
                try{ overrides = JSON.parse(overridesRaw); }catch(e){ overrides = {}; }

                filtered.forEach(entry => {
                    const key = (entry.name||'') + '|' + (entry.phone||'');
                    
                    // Calculate overdue information
                    let overdueCount = 0;
                    let maxOverdueDays = 0;
                    let nextPaymentDate = '';
                    
                    entry.contracts.forEach(c => {
                        const overdueInfo = this.calcOverdue(c.date, c.status);
                        if (overdueInfo.isOverdue) {
                            overdueCount++;
                            if (overdueInfo.days > maxOverdueDays) {
                                maxOverdueDays = overdueInfo.days;
                            }
                        }
                        // Get next payment date (approximation based on contract date and installments)
                        if (c.status === 'Active' && !nextPaymentDate) {
                            const contractDate = new Date(c.date);
                            const today = new Date();
                            const daysSinceStart = Math.floor((today - contractDate) / (1000 * 60 * 60 * 24));
                            const monthsSinceStart = Math.floor(daysSinceStart / 30);
                            const nextMonth = new Date(contractDate);
                            nextMonth.setMonth(nextMonth.getMonth() + monthsSinceStart + 1);
                            nextPaymentDate = nextMonth.toLocaleDateString('th-TH', { day: '2-digit', month: '2-digit', year: 'numeric' });
                        }
                    });
                    
                    // Format overdue display
                    let overdueDisplay = '-';
                    if (overdueCount > 0) {
                        const years = Math.floor(maxOverdueDays / 365);
                        const months = Math.floor((maxOverdueDays % 365) / 30);
                        const days = maxOverdueDays % 30;
                        const parts = [];
                        if (years) parts.push(`${years}ปี`);
                        if (months) parts.push(`${months}ด`);
                        if (days) parts.push(`${days}ว`);
                        overdueDisplay = `<span class="text-red-600 font-bold">${parts.join(' ')}</span>`;
                    }
                    
                    // Compute payment quality
                    const anyOverdue = overdueCount > 0;
                    let quality = anyOverdue ? 'ไม่ดี' : 'ดี';
                    if(overrides[key]) quality = overrides[key];

                    // Pick a representative contract id to link quick-open (first contract)
                    const repCon = entry.contracts[0] ? entry.contracts[0].id : '';

                    const row = $(
                        `<div class="glass-panel p-3 mb-2 customer-row">
                            <div class="grid grid-cols-8 gap-3 items-center text-sm">
                                <div class="col-span-1 font-mono text-sm text-gray-700">${repCon || '-'}</div>
                                <div class="col-span-1 font-bold text-gray-900">${entry.name}</div>
                                <div class="col-span-1 text-sm text-gray-600">${nextPaymentDate || '-'}</div>
                                <div class="col-span-1 text-sm text-center">${overdueDisplay}</div>
                                <div class="col-span-1 text-sm">
                                    <span class="badge bg-${ anyOverdue ? 'red' : 'green' }-100 text-${ anyOverdue ? 'red' : 'green' }-700 px-2 py-1 rounded text-xs">${quality}</span>
                                </div>
                                <div class="col-span-3 flex items-center justify-end gap-2">
                                    <button class="btn-secondary px-3 py-1 text-xs" onclick="app.openCustomer('${encodeURIComponent(entry.name)}','${encodeURIComponent(entry.phone||'')}')">
                                        <i class="fas fa-file-contract mr-1"></i>ดูสัญญา
                                    </button>
                                    <button class="btn-apple px-3 py-1 text-xs btn-primary" onclick="app.recordCall('${entry.phone||''}','${encodeURIComponent(entry.name)}','${repCon}')">
                                        <i class="fas fa-phone mr-1"></i>โทรทันที
                                    </button>
                                </div>
                            </div>
                        </div>`
                    );

                    wrap.append(row);
                });
            },

            exportAllCustomers: function(){
                // Export a summary CSV: name,phone,contracts_count,total_owed
                const map = {};
                this.data.contracts.forEach(c => {
                    const key = (c.name||'') + '|' + (c.phone||'');
                    map[key] = map[key] || { name: c.name||'', phone: c.phone||'', contracts: [], totalOwed: 0 };
                    map[key].contracts.push(c.id);
                    map[key].totalOwed += ((c.total||0)-(c.paid||0));
                });
                const rows = [['name','phone','contracts_count','total_owed']];
                Object.values(map).forEach(m => rows.push([`"${String(m.name).replace(/"/g,'""')}"`, `"${String(m.phone).replace(/"/g,'""')}"`, m.contracts.length, m.totalOwed]));
                const blob = new Blob([rows.map(r=>r.join(',')).join('\n')], { type: 'text/csv' });
                this._downloadBlob('customers_summary.csv', blob);
            },

            openCustomer: function(nameEnc, phoneEnc){
                const name = decodeURIComponent(nameEnc).trim();
                const phone = decodeURIComponent(phoneEnc).trim();
                
                // Filter contracts by matching name AND phone (with trimming for safety)
                // If phone is empty, match only by name
                const contracts = this.data.contracts.filter(c => {
                    const cName = (c.name || '').trim();
                    const cPhone = (c.phone || '').trim();
                    return cName === name && (phone === '' || cPhone === phone);
                });
                
                const body = $('#cust-body');
                body.empty();
                body.append(`<div class="mb-3"><strong>${name}</strong> <div class="text-xs text-gray-500">${phone || 'ไม่มีเบอร์โทร'}</div></div>`);
                
                if(contracts.length === 0) { 
                    body.append('<div class="text-sm text-gray-500">ไม่พบสัญญาของลูกค้านี้</div>'); 
                }
                else{
                    const table = $(`<table class="w-full text-sm border-collapse"><thead class="text-xs text-gray-500 border-b"><tr><th class="px-2 py-2 text-left">สัญญา</th><th class="px-2 py-2 text-left">สถานะ</th><th class="px-2 py-2 text-right">คงเหลือ</th><th class="px-2 py-2"></th></tr></thead><tbody></tbody></table>`);
                    contracts.forEach(c=>{
                        table.find('tbody').append(`<tr class="border-b hover:bg-gray-50"><td class="px-2 py-2 font-mono">${c.id}</td><td class="px-2 py-2 text-xs">${c.status}</td><td class="px-2 py-2 text-right font-bold">${((c.total||0)-(c.paid||0)).toLocaleString()}</td><td class="px-2 py-2 text-right"><button class="btn-secondary px-2 py-1 text-xs" onclick="app.openDetail('${c.id}');app.closeModal('modal-customer')">Open</button></td></tr>`);
                    });
                    body.append(table);
                }
                
                // store last opened customer for export
                this._lastCustomer = { name: name, phone: phone, contracts: contracts };
                $('#cust-title').text(`ลูกค้า: ${name}`);
                $('#modal-customer').removeClass('hidden').addClass('flex');
            },

            exportCustomerContracts: function(){
                const c = this._lastCustomer;
                if(!c || !c.contracts || c.contracts.length === 0){ Swal.fire({ icon: 'info', title: 'ไม่มีสัญญาสำหรับส่งออก' }); return; }
                const headers = ['id','name','phone','date','status','total','paid','installments','cost','resale'];
                const rows = [headers.join(',')];
                c.contracts.forEach(r=>{
                    const vals = headers.map(h=>`"${String(r[h]||'').replace(/"/g,'""')}"`);
                    rows.push(vals.join(','));
                });
                const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
                this._downloadBlob(`${c.name.replace(/\s+/g,'_')}_contracts.csv`, blob);
            },

            // Record a call attempt and open the phone URL or Yalecom scheme
            recordCall: function(phone, customerNameEncoded, contractId){
                const customerName = decodeURIComponent(customerNameEncoded || '') || '';
                if(!phone){ Swal.fire({ icon: 'error', title: 'หมายเลขโทรศัพท์ไม่พบ' }); return; }
                // store call log in localStorage for analytics
                const key = 'call_log_v1';
                let logs = [];
                try{ logs = JSON.parse(localStorage.getItem(key) || '[]'); }catch(e){ logs = []; }
                const timestamp = new Date().toISOString();
                // determine call URL: prefer YALECOM_SCHEME if set else tel:
                const url = this.getCallUrl(phone);
                const method = url && url.startsWith('yalecom:') ? 'yalecom' : 'tel';
                logs.unshift({ time: timestamp, phone: phone, customer: customerName, contractId: contractId || null, method: method });
                try{ localStorage.setItem(key, JSON.stringify(logs.slice(0,200))); }catch(e){}
                // optionally show a brief toast and open the call link
                try{ window.open(url, '_blank'); }catch(e){ window.location = url; }
                Swal.fire({ icon: 'success', title: 'กำลังโทร...', text: phone });
            },

            // construct call URL — supports custom Yalecom scheme if defined in settings
            getCallUrl: function(phone){
                // if user configured a YALECOM_CALL_URL template in localStorage (e.g. "yalecom://call?to=%s"), use it
                try{
                    const tmpl = localStorage.getItem('yalecom_call_template') || '';
                    if(tmpl && tmpl.indexOf('%s') !== -1) return tmpl.replace('%s', encodeURIComponent(phone));
                }catch(e){}
                // default to tel:
                return 'tel:' + phone.replace(/\s+/g,'');
            },

            // Open a contract detail in a floating modal (does not navigate away)
            openDetailModal: function(id){
                const c = this.data.contracts.find(x => x.id === id);
                if(!c){ Swal.fire({ icon: 'error', title: 'ไม่พบสัญญา' }); return; }
                // populate modal content (reuse cust modal body area for compact detail)
                const body = $('#cust-body');
                body.empty();
                body.append(`<div class="mb-2 font-bold">สัญญา: ${c.id} <span class=\"text-xs text-gray-500 ml-2\">${c.status}</span></div>`);
                body.append(`<div class=\"text-sm text-gray-700 mb-2\"><strong>ชื่อลูกค้า:</strong> ${c.name || '-'}<br/><strong>บัตรประชาชน:</strong> ${c.nationalId || (c.idCard||'-')}<br/><strong>ที่อยู่:</strong> ${c.address || '-'}</div>`);
                const phoneBtn = $(`<div class=\"mb-3\"><button class=\"btn-apple btn-primary px-3 py-2 mr-2\" onclick=\"app.recordCall('${c.phone||''}','${encodeURIComponent(c.name||'')}','${c.id}')\">โทรทันที</button><button class=\"btn-secondary px-3 py-2\" onclick=\"app.openDetail('${c.id}');app.closeModal('modal-customer')\">เปิดหน้าเต็ม</button></div>`);
                body.append(phoneBtn);
                // payment summary
                body.append(`<div class=\"mb-3 text-sm text-gray-700\">ยอดคงเหลือ: <strong>${((c.total||0)-(c.paid||0)).toLocaleString()}</strong> • ผ่อน ${c.installments||1} งวด</div>`);
                // timeline area with quick post
                body.append('<div class="mb-2"><label class="text-xs text-gray-500">Timeline</label><div class="mt-2" id="modal-detail-timeline"></div></div>');
                // render timeline
                const tdiv = $('#modal-detail-timeline');
                tdiv.empty();
                if(Array.isArray(c.timeline) && c.timeline.length>0){
                    c.timeline.forEach(t=>{
                        tdiv.append(`<div class=\"p-3 bg-gray-50 rounded mb-2 text-sm\"><div class=\"text-xs text-gray-400\">${t.time}</div><div class=\"mt-1\">${t.text}</div></div>`);
                    });
                } else {
                    tdiv.append('<div class="text-xs text-gray-400">ยังไม่มีบันทึก</div>');
                }
                // quick add timeline input
                body.append(`<div class="mt-3 flex gap-2"><input id="modal-tl-input" class="apple-input text-sm flex-1" placeholder="บันทึกข้อความ..." /><button class="btn-apple btn-primary px-3 py-1" onclick="(function(){ const txt=$('#modal-tl-input').val(); if(!txt) return Swal.fire({icon:'error',title:'กรุณากรอกข้อความ'}); const c = app.data.contracts.find(x=>x.id==='${c.id}'); if(!c.timeline) c.timeline = []; c.timeline.unshift({ time: new Date().toLocaleDateString(), text: txt }); app.saveData(); app.openDetailModal('${c.id}'); })()">โพสต์</button></div>`);
                $('#cust-title').text(`สัญญา ${c.id}`);
                $('#modal-customer').removeClass('hidden').addClass('flex');
            },

            // Show status change logs modal
            showStatusLogs: function(){
                const wrap = $('#status-logs-list'); wrap.empty();
                let logs = [];
                try{ logs = JSON.parse(localStorage.getItem('status_change_log_v1') || '[]'); }catch(e){ logs = []; }
                if(!logs || logs.length === 0){ wrap.html('<div class="text-xs text-gray-500 p-3">ไม่มีบันทึก</div>'); }
                else {
                    logs.forEach(l => {
                        const t = $('<div class="p-2 border-b last:border-b-0"></div>');
                        t.append(`<div class="text-xs text-gray-400">${new Date(l.time).toLocaleString()}</div>`);
                        t.append(`<div class="text-sm font-bold">Contract ${l.contractId}</div>`);
                        t.append(`<div class="text-xs text-gray-500">From: <strong>${l.from}</strong> → To: <strong>${l.to}</strong> by <em>${l.by}</em></div>`);
                        wrap.append(t);
                    });
                }
                $('#modal-status-logs').removeClass('hidden').addClass('flex');
            },

            clearStatusLogs: function(){
                if(!confirm('ลบประวัติการเปลี่ยนสถานะทั้งหมด?')) return;
                try{ localStorage.removeItem('status_change_log_v1'); }catch(e){}
                this.showStatusLogs();
            },

            // Load, preview, and save receipt settings
            loadReceiptSettings: function(){
                const settings = {
                    name: localStorage.getItem('rcpt_company_name') || 'บริษัท ที แอสเซท แมเนจเม้นท์ จำกัด',
                    address: localStorage.getItem('rcpt_company_address') || '123/45 อาคารทีพลัส ชั้น 9 ถนนสุขุมวิท แขวงคลองตัน เขตคลองเตย กรุงเทพฯ 10110',
                    taxId: localStorage.getItem('rcpt_tax_id') || '010556XXXXXXX'
                };
                $('#rcpt-company-name').val(settings.name);
                $('#rcpt-company-address').val(settings.address);
                $('#rcpt-tax-id').val(settings.taxId);
                this.updateReceiptPreview();

                // Add listeners to update preview on input change
                $('#rcpt-company-name, #rcpt-company-address, #rcpt-tax-id').on('input', this.updateReceiptPreview);
            },
            updateReceiptPreview: function(){
                $('#preview-company-name').text($('#rcpt-company-name').val());
                $('#preview-company-address').text($('#rcpt-company-address').val());
                $('#preview-tax-id').text($('#rcpt-tax-id').val());
                const d = new Date();
                const key = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
                $('#preview-rcpt-no').text(`AMC-${key}01-0001`);
            },
            saveReceiptSettings: function(){
                try {
                    localStorage.setItem('rcpt_company_name', $('#rcpt-company-name').val());
                    localStorage.setItem('rcpt_company_address', $('#rcpt-company-address').val());
                    localStorage.setItem('rcpt_tax_id', $('#rcpt-tax-id').val());
                    Swal.fire({ icon: 'success', title: 'บันทึกการตั้งค่าใบเสร็จแล้ว' });
                } catch(e) {
                    Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาดในการบันทึก' });
                }
            },

            openPaymentModal: function() {
                const c = this.data.contracts.find(x => x.id === this.data.currentId);
                if(!c) { Swal.fire({ icon: 'error', title: 'ไม่พบสัญญา', text: 'กรุณาเลือกสัญญาก่อนทำรายการ' }); return; }
                $('#pay-modal-balance').text(((c.total || 0) - (c.paid || 0)).toLocaleString());
                this.openModal('modal-payment');
                this.setPayType('min');
            },

            setPayType: function(type) {
                $('.pay-option').removeClass('selected');
                const $btn = $('#btn-'+type);
                if($btn.length) $btn.addClass('selected');
                $('#pay-type').val(type);
                $('#div-discount').addClass('hidden');

                const c = this.data.contracts.find(x => x.id === this.data.currentId) || { total:0, paid:0, installments:1 };
                const input = $('#pay-amount');
                input.prop('readonly', false);

                if(type === 'min') input.val(600);
                else if(type === 'bill') {
                    const val = Math.ceil((c.total || 0) / (c.installments || 1)) + 100;
                    input.val(val);
                    const next = c.installments ? (Math.ceil(((c.paid || 0)/(c.total || 1))* (c.installments || 1)) + 1) : 1;
                    $('#lbl-installment').text(`งวด ${next}/${c.installments || 1}`);
                } else {
                    $('#div-discount').removeClass('hidden');
                    input.val(((c.total || 0) - (c.paid || 0)) + 100);
                    input.prop('readonly', true);
                }
            },

            calcCloseAmount: function() {
                const disc = parseFloat($('#pay-discount').val()) || 0;
                const c = this.data.contracts.find(x => x.id === this.data.currentId);
                if(!c) return;
                const bal = (c.total || 0) - (c.paid || 0);
                const val = Math.floor(bal * (1-disc)) + 100;
                $('#pay-amount').val(val);
            },

            submitPayment: function() {
                const amt = parseFloat($('#pay-amount').val());
                if(!amt || amt <= 0) { Swal.fire({ icon: 'error', title: 'จำนวนเงินไม่ถูกต้อง' }); return; }
                const c = this.data.contracts.find(x => x.id === this.data.currentId);
                if(!c) { Swal.fire({ icon: 'error', title: 'ไม่พบสัญญา' }); return; }

                let rcpNo = null;
                if($('#req-receipt').is(':checked')) {
                    // Use date-based receipt counter that resets MONTHLY
                    const d = new Date();
                    const key = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}`;
                    const counterKey = `receipt_counter_${key}`;
                    let cnt = 0;
                    try{ cnt = parseInt(localStorage.getItem(counterKey) || '0', 10) || 0; }catch(e){ cnt = 0; }
                    cnt += 1;
                    try{ localStorage.setItem(counterKey, String(cnt)); }catch(e){}
                    const run = String(cnt).padStart(4, '0');
                    rcpNo = `AMC-${key}-${run}`;
                }

                c.paid = (c.paid || 0) + (amt - 100);
                if(!Array.isArray(c.payments)) c.payments = [];
                c.payments.unshift({ date: new Date().toLocaleDateString(), type: $('#pay-type').val() || 'unknown', amount: amt, receipt: rcpNo });
                if((c.paid || 0) >= (c.total || 0)) c.status = 'Closed';

                if(!c.timeline) c.timeline = [];
                let log = `💰 ชำระเงิน ${Number(amt).toLocaleString()} บาท`;
                if(rcpNo) log += ` (ออกใบเสร็จ: ${rcpNo})`;
                c.timeline.unshift({ time: new Date().toLocaleDateString(), text: log });

                this.saveData();
                this.closeModal('modal-payment');
                Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ', text: rcpNo ? `ใบเสร็จ: ${rcpNo}` : '' });
                this.openDetail(this.data.currentId);
                this.renderDashboard();
            },

            showCallLogs: function(){
                const logs = JSON.parse(localStorage.getItem('call_log_v1') || '[]');
                let html = '<div class="space-y-2">';
                if(logs.length === 0) {
                    html += '<p class="text-gray-400 text-sm">ไม่มีประวัติการติดต่อ</p>';
                } else {
                    logs.forEach(log => {
                        const badge = log.result === 'รับสาย' ? 'bg-green-100 text-green-700' : log.result === 'ไม่รับสาย' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';
                        html += `
                            <div class="p-3 bg-gray-50 rounded border">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <span class="font-bold">${log.customerName || 'ไม่ระบุ'}</span>
                                        <span class="badge ${badge} ml-2">${log.result}</span>
                                    </div>
                                    <span class="text-xs text-gray-400">${new Date(log.time).toLocaleString('th-TH')}</span>
                                </div>
                                ${log.note ? `<p class="text-sm text-gray-600 mt-2">${log.note}</p>` : ''}
                            </div>
                        `;
                    });
                }
                html += '</div>';
                html += '<div class="mt-4 flex gap-2"><button onclick="app.clearCallLogs()" class="btn-secondary px-4 py-2">ล้างประวัติ</button></div>';
                Swal.fire({ title: 'ประวัติการติดต่อลูกค้า', html: html, width: '600px', showConfirmButton: false, showCloseButton: true });
            },

            clearCallLogs: function(){
                Swal.fire({
                    title: 'ยืนยันการล้างประวัติ?',
                    text: 'การกระทำนี้ไม่สามารถย้อนกลับได้',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ยืนยัน',
                    cancelButtonText: 'ยกเลิก'
                }).then(result => {
                    if(result.isConfirmed) {
                        localStorage.removeItem('call_log_v1');
                        Swal.fire({ icon: 'success', title: 'ล้างประวัติสำเร็จ' });
                        this.showCallLogs();
                    }
                });
            },

            openUploadSettings: function(){
                const token = localStorage.getItem('upload_token') || '';
                $('#upload-token').val(token);
                this.openModal('modal-settings');
            },

            saveSettings: function(){
                const token = $('#upload-token').val();
                localStorage.setItem('upload_token', token);
                this.closeModal('modal-settings');
                Swal.fire({ icon: 'success', title: 'บันทึกการตั้งค่าแล้ว' });
            },

            // User Management Functions
            renderUsers: function() {
                const users = JSON.parse(localStorage.getItem(this.usersKey) || '[]');
                const container = $('#users-table-container');
                container.empty();

                if (users.length === 0) {
                    container.html('<p class="text-gray-500 text-center py-8">ไม่มีผู้ใช้ในระบบ</p>');
                    return;
                }

                const table = $('<table class="w-full"></table>');
                table.append(`
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700">Username</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700">Display Name</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-gray-700">Role</th>
                            <th class="px-4 py-3 text-center text-xs font-bold text-gray-700">Actions</th>
                        </tr>
                    </thead>
                `);

                const tbody = $('<tbody class="divide-y"></tbody>');
                users.forEach((user, idx) => {
                    const row = $(`
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-3 font-mono text-sm">${user.username}</td>
                            <td class="px-4 py-3 text-sm">${user.displayName || user.username}</td>
                            <td class="px-4 py-3">
                                <span class="badge ${user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">${user.role}</span>
                            </td>
                            <td class="px-4 py-3 text-center">
                                <button onclick="app.editUser(${idx})" class="btn-secondary px-3 py-1 text-xs mr-2">
                                    <i class="fas fa-edit"></i> แก้ไข
                                </button>
                                <button onclick="app.deleteUser(${idx})" class="text-red-500 hover:bg-red-50 px-3 py-1 rounded text-xs">
                                    <i class="fas fa-trash"></i> ลบ
                                </button>
                            </td>
                        </tr>
                    `);
                    tbody.append(row);
                });

                table.append(tbody);
                container.append(table);
            },

            addNewUser: function() {
                Swal.fire({
                    title: 'เพิ่มผู้ใช้ใหม่',
                    html: `
                        <input id="new-username" class="swal2-input" placeholder="Username">
                        <input id="new-password" type="password" class="swal2-input" placeholder="Password">
                        <input id="new-displayname" class="swal2-input" placeholder="Display Name">
                        <select id="new-role" class="swal2-input">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'เพิ่ม',
                    cancelButtonText: 'ยกเลิก',
                    preConfirm: () => {
                        const username = $('#new-username').val();
                        const password = $('#new-password').val();
                        const displayName = $('#new-displayname').val();
                        const role = $('#new-role').val();

                        if (!username || !password) {
                            Swal.showValidationMessage('กรุณากรอก Username และ Password');
                            return false;
                        }

                        return { username, password, displayName, role };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        const users = JSON.parse(localStorage.getItem(this.usersKey) || '[]');
                        users.push(result.value);
                        localStorage.setItem(this.usersKey, JSON.stringify(users));
                        this.renderUsers();
                        Swal.fire({ icon: 'success', title: 'เพิ่มผู้ใช้สำเร็จ' });
                    }
                });
            },

            editUser: function(index) {
                const users = JSON.parse(localStorage.getItem(this.usersKey) || '[]');
                const user = users[index];

                Swal.fire({
                    title: 'แก้ไขผู้ใช้',
                    html: `
                        <input id="edit-username" class="swal2-input" value="${user.username}" readonly>
                        <input id="edit-password" type="password" class="swal2-input" placeholder="New Password (leave blank to keep current)">
                        <input id="edit-displayname" class="swal2-input" value="${user.displayName || ''}" placeholder="Display Name">
                        <select id="edit-role" class="swal2-input">
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    `,
                    showCancelButton: true,
                    confirmButtonText: 'บันทึก',
                    cancelButtonText: 'ยกเลิก',
                    preConfirm: () => {
                        const password = $('#edit-password').val();
                        const displayName = $('#edit-displayname').val();
                        const role = $('#edit-role').val();

                        return { password, displayName, role };
                    }
                }).then((result) => {
                    if (result.isConfirmed) {
                        if (result.value.password) {
                            users[index].password = result.value.password;
                        }
                        users[index].displayName = result.value.displayName;
                        users[index].role = result.value.role;
                        localStorage.setItem(this.usersKey, JSON.stringify(users));
                        this.renderUsers();
                        Swal.fire({ icon: 'success', title: 'แก้ไขสำเร็จ' });
                    }
                });
            },

            deleteUser: function(index) {
                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    text: 'การกระทำนี้ไม่สามารถย้อนกลับได้',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'ลบ',
                    cancelButtonText: 'ยกเลิก',
                    confirmButtonColor: '#ef4444'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const users = JSON.parse(localStorage.getItem(this.usersKey) || '[]');
                        users.splice(index, 1);
                        localStorage.setItem(this.usersKey, JSON.stringify(users));
                        this.renderUsers();
                        Swal.fire({ icon: 'success', title: 'ลบผู้ใช้สำเร็จ' });
                    }
                });
            },

            // Financial Reports Functions
            renderReports: function() {
                const contracts = this.data.contracts || [];
                const filterStatus = $('#report-filter-status').val() || '';
                
                // Filter contracts by status
                const filtered = filterStatus ? contracts.filter(c => c.status === filterStatus) : contracts;
                
                // Calculate totals
                const totalIncome = filtered.reduce((sum, c) => sum + (c.paid || 0), 0);
                const totalPending = filtered.reduce((sum, c) => sum + ((c.total || 0) - (c.paid || 0)), 0);
                const totalContracts = filtered.length;

                $('#report-total-income').text(totalIncome.toLocaleString() + ' ฿');
                $('#report-pending').text(totalPending.toLocaleString() + ' ฿');
                $('#report-total-contracts').text(totalContracts);

                // Count by status
                const byStatus = {};
                filtered.forEach(c => {
                    const status = c.status || 'Unknown';
                    byStatus[status] = (byStatus[status] || 0) + 1;
                });

                // Show status summary
                const statusSummary = $('#report-status-summary');
                statusSummary.empty();
                Object.keys(byStatus).forEach(status => {
                    statusSummary.append(`<div>${status}: <strong>${byStatus[status]}</strong></div>`);
                });

                // Build payment details table
                const paymentTable = $('#report-payment-table');
                paymentTable.empty();

                if (filtered.length === 0) {
                    paymentTable.html('<p class="text-gray-500 text-center py-4">ไม่มีข้อมูล</p>');
                    return;
                }

                const table = $('<table class="w-full text-sm"></table>');
                table.append(`
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-bold">สัญญา</th>
                            <th class="px-3 py-2 text-left text-xs font-bold">ชื่อลูกค้า</th>
                            <th class="px-3 py-2 text-right text-xs font-bold">ยอดชำระแล้ว</th>
                            <th class="px-3 py-2 text-right text-xs font-bold">ยอดคงเหลือ</th>
                            <th class="px-3 py-2 text-center text-xs font-bold">สถานะ</th>
                            <th class="px-3 py-2 text-center text-xs font-bold">การดำเนินการ</th>
                        </tr>
                    </thead>
                `);

                const tbody = $('<tbody class="divide-y"></tbody>');
                filtered.forEach(c => {
                    const paid = c.paid || 0;
                    const total = c.total || 0;
                    const remaining = total - paid;
                    
                    // Determine payment status
                    let paymentStatus = 'รออนุมัติ';
                    let statusColor = 'orange';
                    
                    if (c.status === 'Closed') {
                        paymentStatus = 'สำเร็จ';
                        statusColor = 'green';
                    } else if (c.status === 'Active') {
                        paymentStatus = 'กำลังชำระ';
                        statusColor = 'blue';
                    } else if (c.status === 'Cancelled') {
                        paymentStatus = 'ยกเลิก';
                        statusColor = 'red';
                    }

                    tbody.append(`
                        <tr class="hover:bg-gray-50">
                            <td class="px-3 py-2 font-mono">${c.id}</td>
                            <td class="px-3 py-2">${c.name || '-'}</td>
                            <td class="px-3 py-2 text-right font-bold text-green-600">${paid.toLocaleString()} ฿</td>
                            <td class="px-3 py-2 text-right font-bold text-red-600">${remaining.toLocaleString()} ฿</td>
                            <td class="px-3 py-2 text-center">
                                <span class="badge bg-${statusColor}-100 text-${statusColor}-700 px-2 py-1 rounded text-xs">${paymentStatus}</span>
                            </td>
                            <td class="px-3 py-2 text-center">
                                <button onclick="app.openDetail('${c.id}')" class="btn-secondary px-2 py-1 text-xs" title="ดูรายละเอียดสัญญา">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `);
                });

                table.append(tbody);
                paymentTable.append(table);
            },

            exportReports: function() {
                const contracts = this.data.contracts || [];
                const filterStatus = $('#report-filter-status').val();
                const filtered = filterStatus ? contracts.filter(c => c.status === filterStatus) : contracts;

                if (filtered.length === 0) {
                    Swal.fire({ icon: 'info', title: 'ไม่มีข้อมูลสำหรับส่งออก' });
                    return;
                }

                const headers = ['id', 'name', 'phone', 'status', 'total', 'paid', 'remaining', 'date'];
                const rows = [headers.join(',')];
                
                filtered.forEach(c => {
                    const remaining = (c.total || 0) - (c.paid || 0);
                    const vals = [
                        `"${c.id || ''}"`,
                        `"${(c.name || '').replace(/"/g, '""')}"`,
                        `"${c.phone || ''}"`,
                        `"${c.status || ''}"`,
                        c.total || 0,
                        c.paid || 0,
                        remaining,
                        `"${c.date || ''}"`
                    ];
                    rows.push(vals.join(','));
                });

                const blob = new Blob([rows.join('\n')], { type: 'text/csv;charset=utf-8;' });
                const timestamp = new Date().toISOString().slice(0, 10);
                this._downloadBlob(`financial_report_${timestamp}.csv`, blob);
            }
        };

        // expose for automated tests and external scripts
        try{ window.app = app; }catch(e){}
        $(document).ready(() => app.init());
    </script>
    </div> <!-- end app-container -->
</body>
</html>